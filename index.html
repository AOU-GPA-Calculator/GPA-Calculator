<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AOU GPA Calculator</title>
  <meta name="theme-color" content="#061b2c">
  <link rel="manifest" href="manifest.json">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#061b2c; --bg2:#0a2b45;
      --card-bg: rgba(255,255,255,.05);
      --border: rgba(255,255,255,.12);
      --text:#eaf2ff; --muted: rgba(234,242,255,.65);
      --gold:#f6b100; --gold2:#ffbf2f;
      --danger:#ff5b5b; --ok:#4ee29a;
      --input-bg: rgba(0,0,0,.25);
      --radius: 16px;
      --blue-header: #2563eb; /* For the Info Table */
      --mono: ui-monospace, monospace;
    }
    html[data-theme="light"]{
      --bg1:#f6f8ff; --bg2:#eef2ff;
      --card-bg: #fff;
      --border: rgba(0,0,0,.10);
      --text:#0b1220; --muted: rgba(11,18,32,.65);
      --input-bg: #f0f2f5;
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Cairo", sans-serif; background: linear-gradient(180deg, var(--bg1), var(--bg2)); color: var(--text); min-height: 100vh; padding-bottom: 60px; }
    .wrap { max-width: 800px; margin: 20px auto; padding: 0 16px; }
    
    /* Top Bar */
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .brand h1 { margin:0; font-size:22px; font-weight:900; }
    .brand p { margin:0; font-size:12px; color:var(--muted); }
    
    .btn { padding: 8px 16px; border-radius: 99px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; font-weight: 700; font-size:13px; transition:.2s; }
    #btnInstall { display: none; background: var(--text); color: var(--bg1); }

    /* Tabs */
    .mainTabs { display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
    .tab { background:transparent; border:1px solid var(--border); padding:10px 30px; border-radius:12px; color:var(--muted); font-weight:700; cursor:pointer; }
    .tab.active { background:rgba(246,177,0,0.15); color:var(--gold); border-color:var(--gold); }
    
    .panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    
    /* Mode Switch */
    .modeSwitch { display:flex; gap:10px; margin-bottom:20px; background:rgba(0,0,0,0.2); padding:5px; border-radius:12px; }
    .modeBtn { flex:1; padding:10px; border-radius:8px; border:none; background:transparent; color:var(--muted); font-weight:700; cursor:pointer; }
    .modeBtn.active { background:var(--card-bg); color:var(--text); box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    
    /* --- TABLE & INPUTS --- */
    .thead { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 100px; gap: 10px; padding: 0 10px 10px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 800; color: var(--muted); text-align: center; }
    
    .trow { 
      display: grid; grid-template-columns: 50px 1fr 1fr 1fr 100px; gap: 10px; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); 
    }
    
    input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); text-align: center; font-weight: 700; outline: none; font-size:16px; }
    input:focus { border-color: var(--gold); }
    input.code-input { text-transform: uppercase; font-family: var(--mono); }

    /* Badge for Status */
    .badge { display:inline-flex; align-items:center; justify-content:center; padding:5px 10px; border-radius:8px; font-size:11px; font-weight:800; width:100%; }
    .badge.ok { background:rgba(78,226,154,0.1); color:var(--ok); }
    .badge.dup { background:rgba(255,91,91,0.1); color:var(--danger); text-decoration:line-through; opacity:0.7; }
    
    .btn-del { width:100%; height:45px; border-radius:12px; border:1px solid rgba(255,91,91,0.3); background:rgba(255,91,91,0.1); color:var(--danger); cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center; }

    .mobile-label { display: none; } 
    
    /* --- MOBILE VIEW --- */
    @media (max-width: 768px) {
        .thead { display: none !important; }
        
        .trow {
            display: flex; flex-direction: column; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            gap: 15px; 
            margin-bottom: 15px;
        }
        html[data-theme="light"] .trow { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .mobile-label { display: block; font-size: 13px; font-weight: 800; margin-bottom: 8px; color: var(--gold); text-align: left; }
        html[dir="rtl"] .mobile-label { text-align: right; }

        .cell-code { order: 1; width: 100%; }
        .mobile-split { order: 2; display: flex; gap: 15px; width: 100%; }
        .cell-half { flex: 1; }
        .cell-status { order: 3; width: 100%; }
        .cell-del { order: 4; width: 100%; margin-top: 5px; }
    }
    @media (min-width: 769px) { .mobile-split { display: contents; } }

    /* --- RESULTS (Yellow Style) --- */
    .big-actions { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; }
    .btn-block { width: 100%; padding: 16px; border-radius: 99px; font-weight: 900; font-size: 16px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-yellow { background: linear-gradient(180deg, var(--gold2), var(--gold)); color: #1b1400; box-shadow: 0 4px 20px rgba(246,177,0,0.3); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }

    .results-area { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); }
    .res-num { font-size: 64px; font-weight: 900; line-height: 1; margin-bottom: 5px; letter-spacing: -1px; }
    .res-label { font-size: 14px; color: var(--muted); font-weight: 700; margin-bottom: 10px; }
    .res-badge { display: inline-block; padding: 8px 24px; border-radius: 12px; border: 1px solid var(--gold); color: var(--gold); background: rgba(246,177,0,0.1); font-weight: 900; }
    
    .hidden { display: none !important; }

    /* Rules Box */
    .ruleBox { margin: 14px 0 0; border-radius: 16px; border: 1px solid var(--border); background: rgba(255,255,255,.06); padding: 12px 14px; color: var(--muted); font-size: 13px; line-height: 1.6; text-align: center; font-weight: 700; }
    html[data-theme="light"] .ruleBox { background: rgba(255,255,255,.70); }
    .ruleNote { font-size: 12px; color: var(--danger); margin-top: 6px; display: block; opacity: 0.9; }
    
    /* Smart Warning Box */
    .dupWarning { margin-top:10px; padding:10px; background:rgba(246,177,0,0.1); border:1px solid var(--gold); border-radius:12px; color:var(--gold); font-size:13px; text-align:center; animation: popIn 0.3s; }
    @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }

    /* --- INFO PANEL STYLES --- */
    .info-header { text-align:center; margin-bottom:20px; }
    .info-header h2 { margin:0; font-size:24px; font-weight:900; color:var(--text); }
    
    .info-section { margin-bottom:20px; background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; border:1px solid var(--border); }
    .info-title { display:flex; align-items:center; gap:8px; font-weight:900; font-size:16px; margin-bottom:10px; color:var(--gold); }
    
    .info-table { width:100%; border-collapse:collapse; font-size:13px; font-weight:700; }
    .info-table th { background:var(--blue-header); color:#fff; padding:10px; text-align:center; border:1px solid var(--border); }
    .info-table td { padding:10px; text-align:center; border:1px solid var(--border); color:var(--muted); }
    
    details { margin-bottom:8px; border:1px solid var(--border); border-radius:10px; overflow:hidden; transition:0.3s; }
    details[open] { background:rgba(255,255,255,0.03); border-color:var(--gold); }
    summary { padding:12px; cursor:pointer; font-weight:800; list-style:none; display:flex; justify-content:space-between; align-items:center; }
    summary::after { content: '+'; font-size:18px; color:var(--gold); }
    details[open] summary::after { content: '-'; }
    .faq-content { padding:12px; font-size:13px; line-height:1.6; color:var(--muted); border-top:1px solid var(--border); }

    /* Footer & Utils */
    .footer { text-align:center; font-size:12px; color:var(--muted); margin-top:30px; line-height:1.6; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; display:flex; align-items:center; justify-content:center; padding:20px; }
    .modal-box { background:var(--bg1); padding:30px; border-radius:20px; max-width:400px; text-align:center; border:1px solid var(--border); }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--ok); color: #000; padding: 10px 24px; border-radius: 30px; font-weight: 800; z-index: 1000; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  </style>
</head>

<body>
    
  <div class="modal" id="disclaimerModal">
    <div class="modal-box">
      <h2 style="color:var(--gold); margin-top:0;">‚ö†Ô∏è Disclaimer</h2>
      <p style="font-size:14px; line-height:1.6;">This tool is for guidance only.<br>Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ© ŸÑŸÑÿ•ÿ±ÿ¥ÿßÿØ ŸÅŸÇÿ∑.</p>
      <button class="btn btn-yellow" style="padding:10px 30px;" onclick="document.getElementById('disclaimerModal').style.display='none'">I Understand / ŸÅŸáŸÖÿ™</button>
    </div>
  </div>

  <div class="toast" id="toast">Saved ‚úÖ</div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>AOU GPA</h1>
        <p>Student Calculator / ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿπÿØŸÑ</p>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="btnInstall">üì≤ Install</button>
        <button class="btn" onclick="toggleTheme()">üåó</button>
        <button class="btn" onclick="toggleLang()">EN/AR</button>
      </div>
    </div>

    <div class="mainTabs">
      <button class="tab active" id="tab1" onclick="switchTab('calc')">Calculator</button>
      <button class="tab" id="tab2" onclick="switchTab('info')">Info</button>
    </div>

    <div class="panel" id="panelCalc">
      <div class="modeSwitch">
        <button class="modeBtn active" id="btnCurr" onclick="setMode('current')">Current / ŸÅÿµŸÑŸä</button>
        <button class="modeBtn" id="btnExp" onclick="setMode('expected')">Cumulative / ÿ™ÿ±ÿßŸÉŸÖŸä</button>
      </div>

      <div id="prevData" class="hidden" style="margin-bottom: 20px; border-bottom:1px solid var(--border); padding-bottom:20px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
              <div>
                  <div class="mobile-label">Prev GPA / ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≥ÿßÿ®ŸÇ</div>
                  <input type="number" id="prevGpa" step="0.01" placeholder="Ex: 2.85">
              </div>
              <div>
                  <div class="mobile-label">Completed Hours / ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ©</div>
                  <input type="number" id="prevHours" step="1" placeholder="Ex: 60">
              </div>
          </div>
      </div>

      <div class="ruleBox">
        <span data-i18n="rule">Retake Rule: Latest attempt counts, previous are Replaced.</span>
        <span class="ruleNote" data-i18n="retakeNote">* Note: According to AOU regulations, retaking a course is not permitted if the previous grade was 'B' or higher.</span>
        
        <div class="dupWarning" id="dupBox" style="display:none;">
            ‚ö†Ô∏è <span data-i18n="dupWarning">Important: You cannot register the same course twice in the same semester. Duplicates here are treated as Retakes.</span>
        </div>
      </div>

      <div class="thead" style="margin-top:15px;">
        <div>Del</div>
        <div data-lang="hours">Credit Hours</div>
        <div data-lang="grade">Grade (100)</div>
        <div data-lang="code">Course Code</div>
        <div data-lang="status">Status</div>
      </div>

      <div id="rowsArea" class="table-container"></div>

      <div class="big-actions">
          <button class="btn-block btn-yellow" onclick="addRow()">+ Add Course / ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿßÿØÿ©</button>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <button class="btn-block btn-outline" onclick="resetAll()">Reset / ŸÖÿ≥ÿ≠</button>
              <button class="btn-block btn-yellow" onclick="compute()">Calculate / ÿßÿ≠ÿ≥ÿ®</button>
          </div>
      </div>

      <div class="results-area">
          <div class="res-num" id="semGpa">0.00</div>
          <div class="res-label" data-lang="semGpa">SEMESTER GPA</div>
          <div id="semRank" class="res-badge hidden">Excellent</div>

          <div id="cumBlock" class="hidden" style="margin-top:30px; padding-top:20px; border-top:1px dashed var(--border);">
              <div class="res-num" id="cumGpa" style="font-size:50px;">0.00</div>
              <div class="res-label" data-lang="cumGpa">CUMULATIVE GPA</div>
              <div id="cumRank" class="res-badge hidden">Excellent</div>
          </div>
      </div>
    </div>

    <div class="panel hidden" id="panelInfo">
        <div class="info-header">
            <h2 data-i18n="aboutTitle">About this calculator</h2>
        </div>

        <div class="info-section">
            <div class="info-title">‚ÑπÔ∏è <span data-i18n="aboutTitle">About</span></div>
            <div style="font-size:13px; line-height:1.6; color:var(--text);">
               <span data-i18n="aboutText">This calculator is designed for AOU students...</span>
            </div>
        </div>

        <div class="info-section">
            <div class="info-title">üéì <span data-i18n="scaleTitle">Grading Scale</span></div>
            <table class="info-table">
                <thead>
                    <tr>
                        <th data-i18n="percentHead">Percentage</th>
                        <th data-i18n="pointsHead">Points</th>
                        <th data-i18n="gradeHead">Grade</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>90-100%</td><td>4.0</td><td>A</td></tr>
                    <tr><td>82-89%</td><td>3.5</td><td>B+</td></tr>
                    <tr><td>74-81%</td><td>3.0</td><td>B</td></tr>
                    <tr><td>66-73%</td><td>2.5</td><td>C+</td></tr>
                    <tr><td>58-65%</td><td>2.0</td><td>C</td></tr>
                    <tr><td>50-57%</td><td>1.5</td><td>D</td></tr>
                    <tr><td>Below 50%</td><td>0.0</td><td>F</td></tr>
                </tbody>
            </table>
        </div>

        <div class="info-section">
            <div class="info-title">‚ùì <span data-i18n="faqTitle">FAQ</span></div>
            
            <details>
                <summary data-i18n="q1">How to use?</summary>
                <div class="faq-content" data-i18n="a1">Enter your previous GPA/Hours...</div>
            </details>
            
            <details>
                <summary data-i18n="q2">Retakes?</summary>
                <div class="faq-content" data-i18n="a2">Duplicate courses are treated as retakes...</div>
            </details>
            
            <details>
                <summary data-i18n="q3">Official?</summary>
                <div class="faq-content" data-i18n="a3">No, this is a guidance tool...</div>
            </details>
        </div>

        <div class="footer">Built by Homam Shaaban.</div>
    </div>

    <div class="footer">¬© <span id="yr"></span> AOU Calculator</div>
  </div>

<script>
let LANG = 'en';
let MODE = 'current';
const STORAGE_KEY = "aou_gpa_final";

const TEXT = {
    en: { 
        hours: "Credit Hours", grade: "Grade (100)", code: "Course Code", status: "Status", semGpa: "SEMESTER GPA", cumGpa: "CUMULATIVE GPA", counted: "Counted", dup: "Replaced",
        rule: "Retake Rule: Latest attempt counts, previous are Replaced.",
        retakeNote: "* Note: According to AOU regulations, retaking a course is not permitted if the previous grade was 'B' or higher.",
        dupWarning: "Important: You cannot register the same course twice in the same semester. Duplicates here are treated as Retakes.",
        
        // Info Tab
        aboutTitle: "About this calculator",
        aboutText: "This calculator is designed for AOU students to help calculate Semester GPA and Forecast Cumulative GPA based on university grading system.",
        scaleTitle: "Grading Scale",
        gradeHead: "Grade", pointsHead: "Points", percentHead: "Percentage",
        faqTitle: "Frequently Asked Questions",
        q1: "How to use?", a1: "Enter your previous GPA and completed hours (if any), then add your current semester courses. Click Calculate.",
        q2: "What about Retakes?", a2: "If you enter the same course code twice (e.g. GR101), the calculator will automatically count the new grade and replace the old one.",
        q3: "Is this official?", a3: "No, this is a student-developed tool for guidance purposes. Please rely on the official SIS for final results."
    },
    ar: { 
        hours: "ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™", grade: "ÿßŸÑÿØÿ±ÿ¨ÿ© (ŸÖŸÜ 100)", code: "ÿßÿ≥ŸÖ/ŸÉŸàÿØ ÿßŸÑŸÖÿßÿØÿ©", status: "ÿßŸÑÿ≠ÿßŸÑÿ©", semGpa: "ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑŸÅÿµŸÑŸä", cumGpa: "ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸä", counted: "ŸÖÿ≠ÿ™ÿ≥ÿ®", dup: "ŸÖŸÉÿ±ÿ±",
        rule: "ŸÇÿßÿπÿØÿ© ÿßŸÑÿ•ÿπÿßÿØÿ©: ŸäŸèÿ≠ÿ≥ÿ® ÿ¢ÿÆÿ± ŸÖÿ≠ÿßŸàŸÑÿ© ŸÑŸÑŸÖŸÇÿ±ÿ± ŸÅŸÇÿ∑.",
        retakeNote: "* ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≠ÿ≥ÿ® ŸÑŸàÿßÿ¶ÿ≠ ÿßŸÑÿ¨ÿßŸÖÿπÿ©ÿå ŸÑÿß ŸäŸèÿ≥ŸÖÿ≠ ÿ®ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖŸÇÿ±ÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© 'B' ÿ£Ÿà ÿ£ÿπŸÑŸâ.",
        dupWarning: "ÿ™ŸÜÿ®ŸäŸá: ÿ£ŸÉÿßÿØŸäŸÖŸäÿßŸã ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÜŸÅÿ≥ ÿßŸÑŸÖÿßÿØÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿµŸÑ. ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸáŸÜÿß ŸÑÿ∫ÿ±ÿ∂ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿπÿßÿØÿ© ŸÅŸÇÿ∑.",
        
        // Info Tab
        aboutTitle: "ÿ≠ŸàŸÑ ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©",
        aboutText: "ÿ™ŸÖ ÿ™ÿµŸÖŸäŸÖ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿØÿßÿ© ŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿ∑ŸÑÿßÿ® ÿßŸÑÿ¨ÿßŸÖÿπÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ© ŸÅŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑŸÅÿµŸÑŸä Ÿàÿ™ŸàŸÇÿπ ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸä ÿ®ÿØŸÇÿ©.",
        scaleTitle: "ÿ≥ŸÑŸÖ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™",
        gradeHead: "ÿßŸÑÿØÿ±ÿ¨ÿ©", pointsHead: "ÿßŸÑŸÜŸÇÿßÿ∑", percentHead: "ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ©",
        faqTitle: "ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©",
        q1: "ŸÉŸäŸÅ ÿ£ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©ÿü", a1: "ÿ£ÿØÿÆŸÑ ŸÖÿπÿØŸÑŸÉ ÿßŸÑÿ≥ÿßÿ®ŸÇ Ÿàÿ≥ÿßÿπÿßÿ™ŸÉ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØ)ÿå ÿ´ŸÖ ÿ£ÿ∂ŸÅ ŸÖŸàÿßÿØ ÿßŸÑŸÅÿµŸÑ ÿßŸÑÿ≠ÿßŸÑŸä Ÿàÿßÿ∂ÿ∫ÿ∑ ÿßÿ≠ÿ≥ÿ®.",
        q2: "ŸÉŸäŸÅ Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿπÿßÿØÿ©ÿü", a2: "ÿ•ÿ∞ÿß ÿ£ÿØÿÆŸÑÿ™ ŸÜŸÅÿ≥ ŸÉŸàÿØ ÿßŸÑŸÖÿßÿØÿ© ŸÖÿ±ÿ™ŸäŸÜ (ŸÖÿ´ŸÑÿßŸã GR101)ÿå ÿ≥ÿ™ŸÇŸàŸÖ ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿØÿ±ÿ¨ÿ© ÿßŸÑÿ£ÿ≠ÿØÿ´ Ÿàÿßÿ≥ÿ™ÿ®ÿπÿßÿØ ÿßŸÑŸÇÿØŸäŸÖÿ©.",
        q3: "ŸáŸÑ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿ±ÿ≥ŸÖŸäÿ©ÿü", a3: "ŸÑÿßÿå Ÿáÿ∞Ÿá ÿ£ÿØÿßÿ© ÿ∑ŸÑÿßÿ®Ÿäÿ© ŸÑŸÑÿ•ÿ±ÿ¥ÿßÿØ ŸÅŸÇÿ∑. ÿßŸÑŸÖÿ±ÿ¨ÿπ ÿßŸÑÿ±ÿ≥ŸÖŸä ŸáŸà ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿßŸÖÿπÿ© SIS."
    }
};

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('yr').textContent = new Date().getFullYear();
    if(!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark');
    applyTheme(localStorage.getItem('theme'));
    restoreState();
    
    // Install
    let deferredPrompt;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e; btnInstall.style.display = 'inline-flex';
    });
    btnInstall.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            // NOTE: Do NOT hide button on install (User Request)
            deferredPrompt = null; 
        }
    });
});

function rowTemplate(data = {}){
    const code = data.code ?? "";
    const score = (data.score ?? "") === "" ? "" : String(data.score);
    const hours = (data.hours ?? "") === "" ? "" : String(data.hours);

    const div = document.createElement('div');
    div.className = 'trow';
    div.innerHTML = `
        <div class="cell-del">
            <button class="btn-del" onclick="removeRow(this)">‚úï</button>
        </div>
        
        <div class="mobile-split">
             <div class="cell-half cell-hours">
                <span class="mobile-label">${LANG==='ar'?'ÿßŸÑÿ≥ÿßÿπÿßÿ™ (Hours)':'Credit Hours'}</span>
                <input type="number" data-act="hours" placeholder="3" min="1" max="12" value="${hours}">
             </div>
             <div class="cell-half cell-grade">
                <span class="mobile-label">${LANG==='ar'?'ÿßŸÑÿØÿ±ÿ¨ÿ© (Grade)':'Grade (100)'}</span>
                <input type="number" data-act="score" placeholder="88" min="0" max="100" step="0.01" value="${score}" onchange="if(this.value) this.value=parseFloat(this.value).toFixed(2)">
             </div>
        </div>
        
        <div class="cell-code">
            <span class="mobile-label">${LANG==='ar'?'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© (Code)':'Course Code'}</span>
            <input type="text" data-act="code" class="code-input" placeholder="GR101" value="${code}">
        </div>
        
        <div class="cell-status">
            <span class="badge ok" data-act="status">---</span>
        </div>
    `;
    
    div.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => { saveState(); }));
    return div;
}

function addRow(data){
    const div = rowTemplate(data);
    document.getElementById('rowsArea').appendChild(div);
}

function removeRow(btn){
    btn.parentElement.parentElement.remove();
    if(document.getElementById('rowsArea').children.length === 0) addRow();
    saveState();
    compute();
}

function aouFromScore(score){
    if (!Number.isFinite(score)) return { points: 0 };
    if (score >= 90) return { points: 4.0 };
    if (score >= 82) return { points: 3.5 };
    if (score >= 74) return { points: 3.0 };
    if (score >= 66) return { points: 2.5 };
    if (score >= 58) return { points: 2.0 };
    if (score >= 50) return { points: 1.5 }; // D = 1.5 (Confirmed by Blue Table Image)
    return { points: 0.0 };
}

function compute(){
    const rows = Array.from(document.getElementById('rowsArea').children);
    
    // 1. Parse Data
    const parsed = rows.map((row, idx) => {
        const codeVal = row.querySelector('[data-act="code"]').value.trim().toUpperCase();
        let scoreVal = parseFloat(row.querySelector('[data-act="score"]').value);
        const hoursVal = parseFloat(row.querySelector('[data-act="hours"]').value);
        return { idx, row, code: codeVal, score: scoreVal, hours: hoursVal };
    });

    // 2. Duplicate Check
    const lastSeen = new Map();
    parsed.forEach(p => { if(p.code) lastSeen.set(p.code, p.idx); });

    let totalPts = 0; 
    let totalHrs = 0;
    let hasDuplicate = false;

    parsed.forEach(p => {
        const statusEl = p.row.querySelector('[data-act="status"]');
        
        if(!p.code || isNaN(p.score) || isNaN(p.hours)){
            statusEl.textContent = '---'; statusEl.className='badge';
            return;
        }

        const isLatest = lastSeen.get(p.code) === p.idx;

        if(isLatest){
            const gp = aouFromScore(p.score).points;
            totalHrs += p.hours;
            totalPts += (gp * p.hours);
            statusEl.textContent = (LANG==='ar' ? TEXT.ar.counted : TEXT.en.counted);
            statusEl.className = 'badge ok';
        } else {
            hasDuplicate = true;
            statusEl.textContent = (LANG==='ar' ? TEXT.ar.dup : TEXT.en.dup);
            statusEl.className = 'badge dup';
        }
    });

    // Smart Warning Toggle
    const dupBox = document.getElementById('dupBox');
    if(dupBox) dupBox.style.display = hasDuplicate ? 'block' : 'none';

    // 3. Results
    const semGpa = totalHrs ? (totalPts / totalHrs) : 0;
    document.getElementById('semGpa').textContent = semGpa.toFixed(2);
    showRank('semRank', semGpa);

    if(MODE === 'expected'){
        const pG = parseFloat(document.getElementById('prevGpa').value) || 0;
        const pH = parseFloat(document.getElementById('prevHours').value) || 0;
        const finalHrs = totalHrs + pH;
        const finalPts = totalPts + (pG * pH);
        const cumGpa = finalHrs ? (finalPts / finalHrs) : 0;
        document.getElementById('cumGpa').textContent = cumGpa.toFixed(2);
        showRank('cumRank', cumGpa);
    }
}

function showRank(elId, gpa){
    const el = document.getElementById(elId);
    el.classList.remove('hidden');
    if(gpa >= 3.5) el.textContent = "Excellent / ŸÖŸÖÿ™ÿßÿ≤";
    else if(gpa >= 2.75) el.textContent = "Very Good / ÿ¨ŸäÿØ ÿ¨ÿØÿßŸã";
    else if(gpa >= 2.00) el.textContent = "Good / ÿ¨ŸäÿØ";
    else el.textContent = "Fail / ÿ±ÿßÿ≥ÿ®"; 
}

function saveState(){
    const rows = Array.from(document.getElementById('rowsArea').children).map(row => ({
        code: row.querySelector('[data-act="code"]').value,
        score: row.querySelector('[data-act="score"]').value,
        hours: row.querySelector('[data-act="hours"]').value
    }));
    const state = {
        mode: MODE,
        prevGpa: document.getElementById('prevGpa').value,
        prevHours: document.getElementById('prevHours').value,
        rows: rows
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    showToast("Saved ‚úÖ");
}

function restoreState(){
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) { addRow(); return; }
        const st = JSON.parse(raw);
        if(st.mode) setMode(st.mode);
        if(st.prevGpa) document.getElementById('prevGpa').value = st.prevGpa;
        if(st.prevHours) document.getElementById('prevHours').value = st.prevHours;
        document.getElementById('rowsArea').innerHTML = '';
        if(st.rows && st.rows.length > 0) st.rows.forEach(r => addRow(r));
        else addRow();
        compute();
    } catch(e) { addRow(); }
}

function resetAll(){
    if(confirm('Clear all fields?')){
        document.getElementById('rowsArea').innerHTML = '';
        addRow();
        document.getElementById('prevGpa').value = '';
        document.getElementById('prevHours').value = '';
        document.getElementById('semGpa').textContent = '0.00';
        document.getElementById('cumGpa').textContent = '0.00';
        saveState();
    }
}

function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(() => t.style.display='none', 1500);
}

function toggleTheme(){
    const current = document.documentElement.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
}
function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
}

function setMode(m){
    MODE = m;
    document.getElementById('btnCurr').classList.toggle('active', m==='current');
    document.getElementById('btnExp').classList.toggle('active', m==='expected');
    if(m==='expected'){
        document.getElementById('prevData').classList.remove('hidden');
        document.getElementById('cumBlock').classList.remove('hidden');
    } else {
        document.getElementById('prevData').classList.add('hidden');
        document.getElementById('cumBlock').classList.add('hidden');
    }
    saveState(); compute();
}

function toggleLang(){
    LANG = (LANG === 'en') ? 'ar' : 'en';
    document.documentElement.dir = (LANG === 'ar') ? 'rtl' : 'ltr';
    
    // Static Text
    const els = document.querySelectorAll('[data-i18n]');
    els.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(TEXT[LANG][key]) el.textContent = TEXT[LANG][key];
    });
    
    // Main Headers
    document.querySelector('[data-lang="hours"]').textContent = TEXT[LANG].hours;
    document.querySelector('[data-lang="grade"]').textContent = TEXT[LANG].grade;
    document.querySelector('[data-lang="code"]').textContent = TEXT[LANG].code;
    document.querySelector('[data-lang="status"]').textContent = TEXT[LANG].status;
    document.querySelector('[data-lang="semGpa"]').textContent = TEXT[LANG].semGpa;
    document.querySelector('[data-lang="cumGpa"]').textContent = TEXT[LANG].cumGpa;

    // Mobile Labels
    const rows = document.querySelectorAll('.trow');
    rows.forEach(row => {
        row.querySelector('.cell-hours .mobile-label').textContent = LANG==='ar'?'ÿßŸÑÿ≥ÿßÿπÿßÿ™ (Hours)':'Credit Hours';
        row.querySelector('.cell-grade .mobile-label').textContent = LANG==='ar'?'ÿßŸÑÿØÿ±ÿ¨ÿ© (Grade)':'Grade (100)';
        row.querySelector('.cell-code .mobile-label').textContent = LANG==='ar'?'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© (Code)':'Course Code';
    });
    compute();
}

function switchTab(t){
    document.getElementById('panelCalc').classList.toggle('hidden', t!=='calc');
    document.getElementById('panelInfo').classList.toggle('hidden', t!=='info');
    document.getElementById('tab1').classList.toggle('active', t==='calc');
    document.getElementById('tab2').classList.toggle('active', t==='info');
}

document.getElementById('prevGpa').addEventListener('input', () => { saveState(); compute(); });
document.getElementById('prevHours').addEventListener('input', () => { saveState(); compute(); });
</script>
</body>
</html>
