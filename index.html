<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary -->
  <title>AOU GPA Calculator</title>
  <meta name="description" content="AOU GPA Calculator â€“ Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta name="author" content="Homam Shaaban" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://aou-gpa-calculator.github.io/GPA-Calculator/" />

  <!-- Open Graph -->
  <meta property="og:title" content="AOU GPA Calculator" />
  <meta property="og:description" content="Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://aou-gpa-calculator.github.io/GPA-Calculator/" />

  <style>
    :root{
      --bg1:#061b2c;
      --bg2:#0a2b45;
      --card1: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.72);
      --gold:#f6b100;
      --gold2:#ffbf2f;
      --shadow: 0 14px 40px rgba(0,0,0,.28);
      --radius: 20px;
      --input: rgba(255,255,255,.10);
      --inputBorder: rgba(255,255,255,.16);
      --danger:#ff5b5b;
      --ok:#4ee29a;
      --btn:#1c3e5f;
      --btn2:#163754;
      --focus: rgba(246,177,0,.26);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif;
      color:var(--text);
      background: radial-gradient(900px 420px at 20% 10%, rgba(246,177,0,.13), transparent 60%),
                  radial-gradient(900px 420px at 80% 20%, rgba(78,226,154,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .wrap{
      max-width: 1060px;
      margin: 34px auto 60px;
      padding: 0 16px;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .titleBlock h1{
      margin:0;
      font-weight: 900;
      font-size: 34px;
      letter-spacing: .2px;
      line-height: 1.15;
    }
    .titleBlock p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .topActions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(8px);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      transition: .14s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(0px); }

    .btn.gold{
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      border-color: rgba(0,0,0,.18);
      color: #1b1400;
      box-shadow: 0 10px 26px rgba(246,177,0,.25);
    }
    .btn.gold:hover{ filter: brightness(1.02); }
    .btn.danger{
      border-color: rgba(255,91,91,.45);
      background: rgba(255,91,91,.10);
      color: #ffd7d7;
    }

    .notice{
      margin-top: 14px;
      border-radius: 999px;
      padding: 12px 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      backdrop-filter: blur(8px);
      text-align:center;
      font-size: 13px;
      line-height: 1.55;
    }

    .tabs{
      margin-top: 18px;
      display:flex;
      justify-content:center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tab{
      min-width: 190px;
      padding: 11px 16px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    .tab.active{
      background: rgba(246,177,0,.16);
      border-color: rgba(246,177,0,.40);
      box-shadow: 0 12px 30px rgba(246,177,0,.12);
    }

    .panel{
      margin-top: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card1), var(--card2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHeader{
      padding: 18px 18px 0;
      text-align:center;
    }
    .panelHeader h2{
      margin: 0;
      font-size: 30px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .panelHeader p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      padding: 0 10px 10px;
    }

    .ruleBox{
      margin: 14px 18px 0;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      text-align: center;
    }

    .content{
      padding: 18px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
      .panelHeader h2{ font-size: 26px; }
      .titleBlock h1{ font-size: 30px; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .label{
      font-weight: 900;
      font-size: 12px;
      color: rgba(234,242,255,.86);
    }
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--inputBorder);
      background: var(--input);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(234,242,255,.55); }
    input:focus, select:focus, textarea:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(246,177,0,.55);
    }

    .table{
      margin-top: 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow:hidden;
      background: rgba(0,0,0,.10);
    }
    .thead, .trow{
      display:grid;
      grid-template-columns: 110px 120px 140px 140px 1fr 120px;
      gap: 10px;
      align-items:center;
      padding: 12px 12px;
    }
    .thead{
      background: rgba(255,255,255,.06);
      color: rgba(234,242,255,.82);
      font-size: 12px;
      font-weight: 900;
    }
    .trow{
      border-top: 1px solid rgba(255,255,255,.08);
    }

    @media (max-width: 980px){
      .thead, .trow{
        grid-template-columns: 110px 120px 140px 1fr;
      }
      .hide-md{ display:none; }
    }
    @media (max-width: 620px){
      .thead, .trow{
        grid-template-columns: 110px 1fr;
      }
      .hide-sm{ display:none; }
    }

    .cell{
      min-width:0;
    }

    .codeInput{
      font-family: var(--mono);
      letter-spacing: .2px;
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(234,242,255,.92);
      font-weight: 900;
      font-size: 12px;
      gap: 6px;
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(78,226,154,.35); background: rgba(78,226,154,.12); }
    .badge.warn{ border-color: rgba(246,177,0,.35); background: rgba(246,177,0,.12); }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items:center;
      justify-content: space-between;
    }
    .actionsLeft, .actionsRight{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .bigResult{
      margin-top: 18px;
      text-align:center;
      padding: 18px 16px 10px;
    }
    .bigNumber{
      font-size: 56px;
      font-weight: 1000;
      letter-spacing: .6px;
      margin: 4px 0 0;
    }
    .bigCaption{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .toast{
      position: fixed;
      top: 16px;
      left: 16px;
      right: 16px;
      margin: 0 auto;
      max-width: 620px;
      display:none;
      z-index: 999;
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid rgba(78,226,154,.40);
      background: rgba(6,27,44,.86);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      color: rgba(210,255,235,.95);
      font-weight: 900;
      text-align: center;
    }

    .printOnly{ display:none; }

    @media print{
      body{ background:#fff; color:#111; }
      .wrap{ max-width: 100%; margin: 0; padding: 0; }
      .topbar, .tabs, .notice, .ruleBox, .actions, .btn, .chip { display:none !important; }
      .panel{ box-shadow:none; border:1px solid #ddd; background:#fff; }
      .panelHeader{ padding: 12px 12px 0; }
      .content{ padding: 12px; }
      .table{ border:1px solid #ddd; background:#fff; }
      .thead{ background:#f3f4f6; color:#111; }
      input, select { border:1px solid #ddd; background:#fff; color:#111; }
      .printOnly{ display:block; margin: 0 0 10px; }
      .bigNumber{ color:#111; }
      .bigCaption, .mini{ color:#333; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <h1 data-i18n="appTitle">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ - Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ÙØªÙˆØ­Ø©</h1>
        <p data-i18n="appSub">ØªØ·Ø¨ÙŠÙ‚ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ù…Ù‚ÙŠØ§Ø³ 4.0 (ÙˆÙÙ‚ Ø³Ù„Ù… AOU)</p>
      </div>

      <div class="topActions">
        <span class="chip" id="scaleChip" data-i18n="scaleChip">Scale: 4.0</span>
        <button class="btn" id="btnCopyLink" type="button" data-i18n="copyLink">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        <button class="btn" id="btnAR" type="button">AR</button>
        <button class="btn" id="btnEN" type="button">EN</button>
      </div>
    </div>

    <div class="notice" data-i18n="notice">
      ØªÙ†Ø¨ÙŠÙ‡: Ø£Ø¯Ø§Ø© Ø·Ù„Ø§Ø¨ÙŠØ© Ù„Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙÙ‚Ø· ÙˆÙ„ÙŠØ³Øª Ù†Ø¸Ø§Ù…Ù‹Ø§ Ø±Ø³Ù…ÙŠÙ‹Ø§ Ù„Ù„Ø¬Ø§Ù…Ø¹Ø©.
    </div>

    <div class="tabs">
      <button class="tab active" id="tabExpected" type="button">
        <span>ğŸ“Š</span><span data-i18n="tabExpected">ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„</span>
      </button>
      <button class="tab" id="tabCurrent" type="button">
        <span>ğŸ“˜</span><span data-i18n="tabCurrent">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
      </button>
    </div>

    <!-- Expected GPA Panel -->
    <section class="panel" id="panelExpected">
      <div class="panelHeader">
        <div class="printOnly">
          <h2 data-i18n="printHeader">ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„</h2>
        </div>
        <h2 data-i18n="expectedTitle">Expected GPA Forecast</h2>
        <p data-i18n="expectedDesc">
          Forecast your final cumulative GPA using completed hours, current GPA, and expected semester performance.
        </p>
      </div>

      <div class="content">
        <div class="grid2">
          <div class="field">
            <div class="label" data-i18n="curCgpa">Current cumulative GPA (0â€“4)</div>
            <input id="exp_baseGpa" type="number" step="0.01" min="0" max="4" placeholder="e.g., 2.82">
          </div>
          <div class="field">
            <div class="label" data-i18n="completedHours">Total completed credit hours</div>
            <input id="exp_baseHours" type="number" step="1" min="0" placeholder="e.g., 103">
          </div>
        </div>

        <div class="ruleBox" data-i18n="rule">
          Retake Rule: If you enter the same Course Code multiple times, only the latest attempt is counted (previous attempts become Replaced).
        </div>

        <div class="table" id="exp_table">
          <div class="thead">
            <div class="cell" data-i18n="colAction">Action</div>
            <div class="cell hide-sm" data-i18n="colStatus">Status</div>
            <div class="cell hide-md" data-i18n="colPoints">GPA Points</div>
            <div class="cell hide-md" data-i18n="colHours">Credit Hours</div>
            <div class="cell" data-i18n="colScore">Grade (0â€“100)</div>
            <div class="cell" data-i18n="colCode">Course Code</div>
          </div>
          <div id="exp_rows"></div>
        </div>

        <div class="actions">
          <div class="actionsLeft">
            <button class="btn" id="exp_export" type="button" data-i18n="exportJson">ØªØµØ¯ÙŠØ± (JSON)</button>
            <button class="btn" id="exp_reset" type="button" data-i18n="reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            <button class="btn" id="exp_autocalc" type="button" data-i18n="autoCalcOn">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ØªØ´ØºÙŠÙ„</button>
          </div>
          <div class="actionsRight">
            <button class="btn gold" id="exp_calc" type="button" data-i18n="calculate">Ø§Ø­Ø³Ø¨</button>
            <button class="btn gold" id="exp_add" type="button" data-i18n="addCourse">Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø±Ø±</button>
          </div>
        </div>

        <div class="bigResult">
          <div class="bigNumber" id="exp_result">0.00</div>
          <div class="bigCaption" id="exp_caption" data-i18n="expCaption">
            Expected cumulative GPA after adding this semester.
          </div>
        </div>

        <div class="actions" style="margin-top:8px">
          <div class="actionsLeft">
            <button class="btn" id="exp_import" type="button" data-i18n="importJson">Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON)</button>
            <input id="exp_importFile" type="file" accept="application/json" style="display:none">
          </div>
          <div class="actionsRight">
            <button class="btn" id="btnPrint" type="button" data-i18n="print">Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>

        <p class="mini" style="margin-top:10px" data-i18n="tipDecimal">
          Tip: You can enter decimals (e.g., 88.5). Letter & points are calculated automatically using AOU scale.
        </p>
      </div>
    </section>

    <!-- Current GPA Panel -->
    <section class="panel" id="panelCurrent" style="display:none">
      <div class="panelHeader">
        <h2 data-i18n="currentTitle">Current GPA Calculator</h2>
        <p data-i18n="currentDesc">
          Enter Course Code, Grade (0â€“100), and Credit Hours. GPA updates automatically (you can turn it off).
        </p>
      </div>

      <div class="content">
        <div class="ruleBox" data-i18n="rule">
          Retake Rule: If you enter the same Course Code multiple times, only the latest attempt is counted (previous attempts become Replaced).
        </div>

        <div class="table" id="cur_table">
          <div class="thead">
            <div class="cell" data-i18n="colAction">Action</div>
            <div class="cell hide-sm" data-i18n="colStatus">Status</div>
            <div class="cell hide-md" data-i18n="colPoints">GPA Points</div>
            <div class="cell hide-md" data-i18n="colHours">Credit Hours</div>
            <div class="cell" data-i18n="colScore">Grade (0â€“100)</div>
            <div class="cell" data-i18n="colCode">Course Code</div>
          </div>
          <div id="cur_rows"></div>
        </div>

        <div class="actions">
          <div class="actionsLeft">
            <button class="btn" id="cur_export" type="button" data-i18n="exportJson">ØªØµØ¯ÙŠØ± (JSON)</button>
            <button class="btn" id="cur_reset" type="button" data-i18n="reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            <button class="btn" id="cur_autocalc" type="button" data-i18n="autoCalcOn">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ØªØ´ØºÙŠÙ„</button>
          </div>
          <div class="actionsRight">
            <button class="btn gold" id="cur_calc" type="button" data-i18n="calculate">Ø§Ø­Ø³Ø¨</button>
            <button class="btn gold" id="cur_add" type="button" data-i18n="addCourse">Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø±Ø±</button>
          </div>
        </div>

        <div class="bigResult">
          <div class="bigNumber" id="cur_result">0.00</div>
          <div class="bigCaption" id="cur_caption" data-i18n="curCaption">
            Current GPA for the entered courses (retake rule applied).
          </div>
        </div>

        <div class="actions" style="margin-top:8px">
          <div class="actionsLeft">
            <button class="btn" id="cur_import" type="button" data-i18n="importJson">Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON)</button>
            <input id="cur_importFile" type="file" accept="application/json" style="display:none">
          </div>
          <div class="actionsRight">
            <span class="chip" id="cur_hint" data-i18n="curHint">Enter all completed courses to compute your current GPA.</span>
          </div>
        </div>

        <p class="mini" style="margin-top:10px" data-i18n="tipDecimal">
          Tip: You can enter decimals (e.g., 88.5). Letter & points are calculated automatically using AOU scale.
        </p>
      </div>
    </section>
  </div>

<script>
/* =========================
   AOU Scale (from your image)
   A 90-100 => 4.0
   B+ 82-89 => 3.5
   B 74-81  => 3.0
   C+ 66-73 => 2.5
   C 58-65  => 2.0
   D 50-57  => 1.0
   F <50    => 0.0
========================= */
function aouFromScore(score){
  if (!Number.isFinite(score)) return { letter: "â€”", points: null };
  if (score >= 90) return { letter: "A", points: 4.0 };
  if (score >= 82) return { letter: "B+", points: 3.5 };
  if (score >= 74) return { letter: "B", points: 3.0 };
  if (score >= 66) return { letter: "C+", points: 2.5 };
  if (score >= 58) return { letter: "C", points: 2.0 };
  if (score >= 50) return { letter: "D", points: 1.0 };
  return { letter: "F", points: 0.0 };
}

function clampScore(v){
  if (!Number.isFinite(v)) return null;
  if (v < 0) return 0;
  if (v > 100) return 100;
  return v;
}

/* =========================
   i18n
========================= */
const i18n = {
  ar: {
    appTitle: "Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ - Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ÙØªÙˆØ­Ø©",
    appSub: "ØªØ·Ø¨ÙŠÙ‚ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ù…Ù‚ÙŠØ§Ø³ 4.0 (ÙˆÙÙ‚ Ø³Ù„Ù… AOU)",
    scaleChip: "Scale: 4.0",
    copyLink: "Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·",
    notice: "ØªÙ†Ø¨ÙŠÙ‡: Ø£Ø¯Ø§Ø© Ø·Ù„Ø§Ø¨ÙŠØ© Ù„Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙÙ‚Ø· ÙˆÙ„ÙŠØ³Øª Ù†Ø¸Ø§Ù…Ù‹Ø§ Ø±Ø³Ù…ÙŠÙ‹Ø§ Ù„Ù„Ø¬Ø§Ù…Ø¹Ø©.",

    tabExpected: "ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„",
    tabCurrent: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ",

    expectedTitle: "ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹",
    expectedDesc: "ØªÙˆÙ‚Ù‘Ø¹ Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©ØŒ ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆØ¯Ø±Ø¬Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©.",
    currentTitle: "Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ",
    currentDesc: "Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚Ø±Ø±ØŒ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø© (0â€“100)ØŒ ÙˆØ§Ù„Ø³Ø§Ø¹Ø§Øª. ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø¯Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§ÙÙ‡).",

    rule: "Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©: Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„Øª Ù†ÙØ³ Course Code Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙ‚Ø· (ÙˆØªØµØ¨Ø­ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Replaced).",

    curCgpa: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (0â€“4)",
    completedHours: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©",

    colAction: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
    colStatus: "Ø§Ù„Ø­Ø§Ù„Ø©",
    colPoints: "Ø§Ù„Ù†Ù‚Ø§Ø·",
    colHours: "Ø§Ù„Ø³Ø§Ø¹Ø§Øª",
    colScore: "Ø§Ù„Ø¯Ø±Ø¬Ø© (0â€“100)",
    colCode: "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚Ø±Ø±",

    addCourse: "Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø±Ø±",
    calculate: "Ø§Ø­Ø³Ø¨",
    reset: "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·",
    exportJson: "ØªØµØ¯ÙŠØ± (JSON)",
    importJson: "Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON)",
    print: "Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±",
    autoCalcOn: "Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ØªØ´ØºÙŠÙ„",
    autoCalcOff: "Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø¥ÙŠÙ‚Ø§Ù",

    expCaption: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.",
    curCaption: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© (Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©).",
    curHint: "Ø£Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ù…ÙÙ†Ø¬Ø²Ø© Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.",
    tipDecimal: "Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ‚Ø¯Ø± ØªØ¯Ø®Ù„ ÙÙˆØ§ØµÙ„ (Ù…Ø«Ù„ 88.5). Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø­Ø±Ù ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø³Ù„Ù… AOU.",

    statusCounted: "Ù…ÙØ­ØªØ³Ø¨",
    statusReplaced: "Ù…Ø³ØªØ¨Ø¯Ù„",
    del: "Ø­Ø°Ù",

    placeholderCode: "Ù…Ø«Ø§Ù„: ITC101",
    placeholderScore: "Ù…Ø«Ø§Ù„: 88.5",
    placeholderHours: "Ù…Ø«Ø§Ù„: 3",

    toastLink: "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…",
    toastJson: "ØªÙ… ØªØµØ¯ÙŠØ± JSON âœ…",
    toastImported: "ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…",
    toastReset: "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· âœ…",
    toastCopied: "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…",

    alertNeedBase: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø© Ø£ÙˆÙ„Ø§Ù‹.",
    alertInvalidRow: "ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚Ø±Ø± + Ø§Ù„Ø³Ø§Ø¹Ø§Øª + Ø§Ù„Ø¯Ø±Ø¬Ø© (0â€“100) Ù„ÙƒÙ„ Ù…Ù‚Ø±Ø±.",
    printHeader: "ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„"
  },
  en: {
    appTitle: "AOU GPA Calculator",
    appSub: "Calculate current GPA and forecast expected GPA on a 4.0 scale (AOU policy)",
    scaleChip: "Scale: 4.0",
    copyLink: "Copy link",
    notice: "Notice: This is a student guidance tool and not an official university system.",

    tabExpected: "Expected GPA",
    tabCurrent: "Current GPA",

    expectedTitle: "Expected GPA Forecast",
    expectedDesc: "Forecast your final cumulative GPA using completed hours, current GPA, and expected semester performance.",
    currentTitle: "Current GPA Calculator",
    currentDesc: "Enter Course Code, Grade (0â€“100), and Credit Hours. GPA updates automatically (you can turn it off).",

    rule: "Retake Rule: If you enter the same Course Code multiple times, only the latest attempt is counted (previous attempts become Replaced).",

    curCgpa: "Current cumulative GPA (0â€“4)",
    completedHours: "Total completed credit hours",

    colAction: "Action",
    colStatus: "Status",
    colPoints: "GPA Points",
    colHours: "Credit Hours",
    colScore: "Grade (0â€“100)",
    colCode: "Course Code",

    addCourse: "Add Course",
    calculate: "Calculate",
    reset: "Reset",
    exportJson: "Export (JSON)",
    importJson: "Import (JSON)",
    print: "Print Report",
    autoCalcOn: "Auto-calc: ON",
    autoCalcOff: "Auto-calc: OFF",

    expCaption: "Expected cumulative GPA after adding this semester.",
    curCaption: "Current GPA for the entered courses (retake rule applied).",
    curHint: "Enter all completed courses to compute your current GPA.",
    tipDecimal: "Tip: You can enter decimals (e.g., 88.5). Letter & points are calculated automatically using AOU scale.",

    statusCounted: "Counted",
    statusReplaced: "Replaced",
    del: "Delete",

    placeholderCode: "e.g., ITC101",
    placeholderScore: "e.g., 88.5",
    placeholderHours: "e.g., 3",

    toastLink: "Link copied âœ…",
    toastJson: "JSON exported âœ…",
    toastImported: "Imported âœ…",
    toastReset: "Reset âœ…",
    toastCopied: "Copied âœ…",

    alertNeedBase: "Please enter your current GPA and completed hours first.",
    alertInvalidRow: "Please enter Course Code, Credit Hours, and Grade (0â€“100) for each course.",
    printHeader: "GPA Calculator Report"
  }
};

let LANG = localStorage.getItem("site_lang") || "ar";

function t(key){
  return (i18n[LANG] && i18n[LANG][key]) ? i18n[LANG][key] : key;
}

function setLang(lang){
  LANG = lang;
  localStorage.setItem("site_lang", lang);
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });

  // Update placeholders for dynamic row inputs
  updateAllRowPlaceholders();

  // Update auto-calc button labels
  refreshAutoCalcButtons();

  // Recompute to refresh status labels
  computeCurrent(false);
  computeExpected(false);
}

/* =========================
   Storage
========================= */
const STORAGE_KEY = "aou_gpa_app_v1";

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    return obj;
  }catch{
    return null;
  }
}

function saveState(){
  const state = {
    lang: LANG,
    current: {
      rows: currentRowsData(),
      auto: CURRENT_AUTOCALC
    },
    expected: {
      baseGpa: getNum("exp_baseGpa"),
      baseHours: getNum("exp_baseHours"),
      rows: expectedRowsData(),
      auto: EXPECTED_AUTOCALC
    }
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function restoreState(){
  const st = loadState();
  if(!st) return;

  if(st.lang) LANG = st.lang;

  // Expected base
  if(st.expected){
    if(Number.isFinite(st.expected.baseGpa)) setVal("exp_baseGpa", st.expected.baseGpa);
    if(Number.isFinite(st.expected.baseHours)) setVal("exp_baseHours", st.expected.baseHours);

    EXPECTED_AUTOCALC = !!st.expected.auto;

    // rows
    clearRows("exp_rows");
    (st.expected.rows || []).forEach(r => addRow("exp_rows", r));
    if((st.expected.rows || []).length === 0) addRow("exp_rows");
  }

  // Current rows
  if(st.current){
    CURRENT_AUTOCALC = !!st.current.auto;
    clearRows("cur_rows");
    (st.current.rows || []).forEach(r => addRow("cur_rows", r));
    if((st.current.rows || []).length === 0) addRow("cur_rows");
  }

  setLang(LANG);
  refreshAutoCalcButtons();
}

/* =========================
   Helpers
========================= */
function $(id){ return document.getElementById(id); }

function setVal(id, v){ $(id).value = v; }

function getNum(id){
  const v = Number($(id).value);
  return Number.isFinite(v) ? v : NaN;
}

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>{ el.style.display = "none"; }, 1500);
}

function downloadText(filename, text){
  const blob = new Blob([text], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function safeUpper(s){
  return String(s || "").trim().toUpperCase();
}

function clearRows(containerId){
  const c = $(containerId);
  while(c.firstChild) c.removeChild(c.firstChild);
}

/* =========================
   Row UI
========================= */
function rowTemplate(data = {}){
  const code = data.code ?? "";
  const score = (data.score ?? "") === "" ? "" : String(data.score);
  const hours = (data.hours ?? "") === "" ? "" : String(data.hours);

  // GPA points displayed cell is computed (readonly badge)
  const div = document.createElement("div");
  div.className = "trow";
  div.innerHTML = `
    <div class="cell">
      <button class="btn danger" type="button" data-act="del">${t("del")}</button>
    </div>

    <div class="cell hide-sm">
      <span class="badge warn" data-act="status">${t("statusCounted")}</span>
    </div>

    <div class="cell hide-md">
      <span class="badge" data-act="points">â€”</span>
      <div class="mini" style="margin-top:4px" data-act="letter">â€”</div>
    </div>

    <div class="cell hide-md">
      <input data-act="hours" inputmode="numeric" type="number" min="0" step="1" placeholder="${t("placeholderHours")}" value="${hours}">
    </div>

    <div class="cell">
      <input data-act="score" inputmode="decimal" type="number" min="0" max="100" step="0.01" placeholder="${t("placeholderScore")}" value="${score}">
    </div>

    <div class="cell">
      <input data-act="code" class="codeInput" type="text" placeholder="${t("placeholderCode")}" value="${code}">
    </div>
  `;
  return div;
}

function addRow(containerId, data){
  const row = rowTemplate(data);
  $(containerId).appendChild(row);
  hookRowEvents(row, containerId);
  updateRowComputed(row);
  saveState();
}

function hookRowEvents(row, containerId){
  const btnDel = row.querySelector('[data-act="del"]');
  btnDel.addEventListener("click", ()=>{
    row.remove();
    if($(containerId).children.length === 0) addRow(containerId);
    recomputeByContainer(containerId);
    saveState();
  });

  // input changes
  ["code","score","hours"].forEach(act=>{
    const el = row.querySelector(`[data-act="${act}"]`);
    el.addEventListener("input", ()=>{
      if(act === "score"){
        const n = clampScore(Number(el.value));
        if(Number.isFinite(n)) el.value = String(n);
      }
      updateRowComputed(row);
      maybeAutoCalc(containerId);
      saveState();
    });
  });
}

function updateRowComputed(row){
  const scoreEl = row.querySelector('[data-act="score"]');
  const hoursEl = row.querySelector('[data-act="hours"]');

  const score = Number(scoreEl.value);
  const hours = Number(hoursEl.value);

  const gp = aouFromScore(score);
  const pointsBadge = row.querySelector('[data-act="points"]');
  const letterEl = row.querySelector('[data-act="letter"]');

  if(Number.isFinite(score) && scoreEl.value !== ""){
    letterEl.textContent = `${gp.letter}`;
  } else {
    letterEl.textContent = "â€”";
  }

  if(Number.isFinite(score) && Number.isFinite(hours) && hoursEl.value !== "" && gp.points !== null){
    pointsBadge.textContent = `${gp.points.toFixed(1)}`;
  } else if (Number.isFinite(score) && gp.points !== null){
    pointsBadge.textContent = `${gp.points.toFixed(1)}`;
  } else {
    pointsBadge.textContent = "â€”";
  }
}

function updateAllRowPlaceholders(){
  // Re-render placeholder texts in all row inputs and delete buttons/status labels
  ["exp_rows","cur_rows"].forEach(containerId=>{
    Array.from($(containerId).children).forEach(row=>{
      row.querySelector('[data-act="del"]').textContent = t("del");
      const status = row.querySelector('[data-act="status"]');
      // status text will be set by retake application, so keep as is
      row.querySelector('[data-act="hours"]').placeholder = t("placeholderHours");
      row.querySelector('[data-act="score"]').placeholder = t("placeholderScore");
      row.querySelector('[data-act="code"]').placeholder = t("placeholderCode");
    });
  });
}

/* =========================
   Retake Rule + Computation
========================= */
function extractRows(containerId){
  const rows = Array.from($(containerId).children);
  const parsed = rows.map((row, idx)=>{
    const code = safeUpper(row.querySelector('[data-act="code"]').value);
    const scoreStr = row.querySelector('[data-act="score"]').value;
    const hoursStr = row.querySelector('[data-act="hours"]') ? row.querySelector('[data-act="hours"]').value : "";

    const score = (scoreStr === "") ? NaN : Number(scoreStr);
    const hours = (hoursStr === "") ? NaN : Number(hoursStr);

    return { idx, row, code, score, hours };
  });

  // Apply retake: last occurrence of same code wins (ignore empty codes for retake)
  const lastIndex = new Map();
  parsed.forEach(p=>{
    if(p.code) lastIndex.set(p.code, p.idx);
  });

  parsed.forEach(p=>{
    const statusEl = p.row.querySelector('[data-act="status"]');
    if(!p.code){
      statusEl.textContent = t("statusCounted");
      statusEl.classList.remove("ok");
      statusEl.classList.add("warn");
      return;
    }
    const isLast = lastIndex.get(p.code) === p.idx;
    statusEl.textContent = isLast ? t("statusCounted") : t("statusReplaced");
    statusEl.classList.toggle("ok", isLast);
    statusEl.classList.toggle("warn", !isLast);
  });

  // Keep only counted rows for calculation
  const counted = parsed.filter(p=>{
    if(!p.code) return true; // empty code still considered (but will fail validation if score/hours given)
    return lastIndex.get(p.code) === p.idx;
  });

  return counted;
}

function validateRow(p){
  // Require: code not empty OR (if empty, then everything must be empty)
  // For calculation we require code + hours + score.
  if(!p.code) return false;
  if(!Number.isFinite(p.hours) || p.hours <= 0) return false;
  if(!Number.isFinite(p.score)) return false;
  const s = clampScore(p.score);
  if(s === null) return false;
  return true;
}

function computeRowsGpa(containerId){
  const counted = extractRows(containerId);

  let totalPoints = 0;
  let totalHours = 0;

  for(const p of counted){
    if(!p.code) continue; // ignore empty codes completely
    if(!validateRow(p)){
      return { ok:false };
    }
    const sc = clampScore(p.score);
    const gp = aouFromScore(sc);
    totalHours += p.hours;
    totalPoints += (gp.points * p.hours);
  }

  if(totalHours <= 0) return { ok:true, gpa: 0, totalHours, totalPoints };
  const gpa = totalPoints / totalHours;
  return { ok:true, gpa, totalHours, totalPoints };
}

function computeExpected(showAlerts = true){
  // base cumulative
  const baseGpa = Number($("exp_baseGpa").value);
  const baseHours = Number($("exp_baseHours").value);

  if(!(Number.isFinite(baseGpa) && Number.isFinite(baseHours) && baseHours >= 0 && baseGpa >= 0)){
    if(showAlerts) alert(t("alertNeedBase"));
    return { ok:false };
  }

  const term = computeRowsGpa("exp_rows");
  if(!term.ok){
    if(showAlerts) alert(t("alertInvalidRow"));
    return { ok:false };
  }

  const basePoints = baseGpa * baseHours;
  const finalHours = baseHours + term.totalHours;
  const finalPoints = basePoints + term.totalPoints;

  const finalGpa = (finalHours > 0) ? (finalPoints / finalHours) : 0;

  $("exp_result").textContent = finalGpa.toFixed(2);
  $("exp_caption").textContent = t("expCaption");

  return { ok:true, finalGpa };
}

function computeCurrent(showAlerts = true){
  const cur = computeRowsGpa("cur_rows");
  if(!cur.ok){
    if(showAlerts) alert(t("alertInvalidRow"));
    return { ok:false };
  }
  $("cur_result").textContent = cur.gpa.toFixed(2);
  $("cur_caption").textContent = t("curCaption");
  return { ok:true, gpa: cur.gpa };
}

function recomputeByContainer(containerId){
  if(containerId === "exp_rows") computeExpected(false);
  if(containerId === "cur_rows") computeCurrent(false);
}

let EXPECTED_AUTOCALC = true;
let CURRENT_AUTOCALC = true;

function maybeAutoCalc(containerId){
  if(containerId === "exp_rows" && EXPECTED_AUTOCALC) computeExpected(false);
  if(containerId === "cur_rows" && CURRENT_AUTOCALC) computeCurrent(false);
}

function refreshAutoCalcButtons(){
  $("exp_autocalc").textContent = EXPECTED_AUTOCALC ? t("autoCalcOn") : t("autoCalcOff");
  $("cur_autocalc").textContent = CURRENT_AUTOCALC ? t("autoCalcOn") : t("autoCalcOff");
}

/* =========================
   Export / Import
========================= */
function currentRowsData(){
  return Array.from($("cur_rows").children).map(row=>({
    code: row.querySelector('[data-act="code"]').value,
    score: row.querySelector('[data-act="score"]').value === "" ? "" : Number(row.querySelector('[data-act="score"]').value),
    hours: row.querySelector('[data-act="hours"]').value === "" ? "" : Number(row.querySelector('[data-act="hours"]').value),
  }));
}
function expectedRowsData(){
  return Array.from($("exp_rows").children).map(row=>({
    code: row.querySelector('[data-act="code"]').value,
    score: row.querySelector('[data-act="score"]').value === "" ? "" : Number(row.querySelector('[data-act="score"]').value),
    hours: row.querySelector('[data-act="hours"]').value === "" ? "" : Number(row.querySelector('[data-act="hours"]').value),
  }));
}

function exportJson(kind){
  const payload = {
    version: 1,
    kind,
    lang: LANG,
    timestamp: new Date().toISOString(),
    data: null
  };

  if(kind === "current"){
    payload.data = {
      rows: currentRowsData(),
      auto: CURRENT_AUTOCALC
    };
  } else {
    payload.data = {
      baseGpa: $("exp_baseGpa").value,
      baseHours: $("exp_baseHours").value,
      rows: expectedRowsData(),
      auto: EXPECTED_AUTOCALC
    };
  }

  const name = `aou-gpa-${kind}.json`;
  downloadText(name, JSON.stringify(payload, null, 2));
  toast(t("toastJson"));
}

function importJsonFromFile(file, kind){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result || ""));
      if(!obj || !obj.data) throw new Error("bad");

      if(kind === "current"){
        const rows = (obj.data.rows || []);
        CURRENT_AUTOCALC = !!obj.data.auto;
        clearRows("cur_rows");
        rows.forEach(r => addRow("cur_rows", r));
        if(rows.length === 0) addRow("cur_rows");
      } else {
        const rows = (obj.data.rows || []);
        $("exp_baseGpa").value = obj.data.baseGpa ?? "";
        $("exp_baseHours").value = obj.data.baseHours ?? "";
        EXPECTED_AUTOCALC = !!obj.data.auto;
        clearRows("exp_rows");
        rows.forEach(r => addRow("exp_rows", r));
        if(rows.length === 0) addRow("exp_rows");
      }

      refreshAutoCalcButtons();
      setLang(LANG);
      toast(t("toastImported"));
      saveState();
    }catch{
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
}

/* =========================
   Tabs
========================= */
function showPanel(which){
  const isExp = (which === "expected");
  $("panelExpected").style.display = isExp ? "block" : "none";
  $("panelCurrent").style.display = isExp ? "none" : "block";

  $("tabExpected").classList.toggle("active", isExp);
  $("tabCurrent").classList.toggle("active", !isExp);

  // Save "last tab" in storage
  localStorage.setItem("last_tab", which);
}

/* =========================
   Copy link / Print
========================= */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast(t("toastCopied"));
  }catch{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    toast(t("toastCopied"));
  }
}

/* =========================
   Init + Wire events
========================= */
function init(){
  // Tabs
  $("tabExpected").addEventListener("click", ()=> showPanel("expected"));
  $("tabCurrent").addEventListener("click", ()=> showPanel("current"));

  const last = localStorage.getItem("last_tab") || "expected";
  showPanel(last);

  // Language buttons
  $("btnAR").addEventListener("click", ()=> setLang("ar"));
  $("btnEN").addEventListener("click", ()=> setLang("en"));

  // Copy link
  $("btnCopyLink").addEventListener("click", ()=>{
    copyText(location.href);
    toast(t("toastLink"));
  });

  // Expected: add/calc/reset/autocalc/export/import
  $("exp_add").addEventListener("click", ()=> addRow("exp_rows"));
  $("exp_calc").addEventListener("click", ()=> computeExpected(true));
  $("exp_reset").addEventListener("click", ()=>{
    $("exp_baseGpa").value = "";
    $("exp_baseHours").value = "";
    clearRows("exp_rows");
    addRow("exp_rows");
    $("exp_result").textContent = "0.00";
    toast(t("toastReset"));
    saveState();
  });
  $("exp_autocalc").addEventListener("click", ()=>{
    EXPECTED_AUTOCALC = !EXPECTED_AUTOCALC;
    refreshAutoCalcButtons();
    if(EXPECTED_AUTOCALC) computeExpected(false);
    saveState();
  });
  $("exp_export").addEventListener("click", ()=> exportJson("expected"));
  $("exp_import").addEventListener("click", ()=> $("exp_importFile").click());
  $("exp_importFile").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(file) importJsonFromFile(file, "expected");
    e.target.value = "";
  });

  // Expected base input auto-calc
  $("exp_baseGpa").addEventListener("input", ()=>{ if(EXPECTED_AUTOCALC) computeExpected(false); saveState(); });
  $("exp_baseHours").addEventListener("input", ()=>{ if(EXPECTED_AUTOCALC) computeExpected(false); saveState(); });

  // Current: add/calc/reset/autocalc/export/import
  $("cur_add").addEventListener("click", ()=> addRow("cur_rows"));
  $("cur_calc").addEventListener("click", ()=> computeCurrent(true));
  $("cur_reset").addEventListener("click", ()=>{
    clearRows("cur_rows");
    addRow("cur_rows");
    $("cur_result").textContent = "0.00";
    toast(t("toastReset"));
    saveState();
  });
  $("cur_autocalc").addEventListener("click", ()=>{
    CURRENT_AUTOCALC = !CURRENT_AUTOCALC;
    refreshAutoCalcButtons();
    if(CURRENT_AUTOCALC) computeCurrent(false);
    saveState();
  });
  $("cur_export").addEventListener("click", ()=> exportJson("current"));
  $("cur_import").addEventListener("click", ()=> $("cur_importFile").click());
  $("cur_importFile").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(file) importJsonFromFile(file, "current");
    e.target.value = "";
  });

  // Print
  $("btnPrint").addEventListener("click", ()=> window.print());

  // First rows if empty
  if($("exp_rows").children.length === 0) addRow("exp_rows");
  if($("cur_rows").children.length === 0) addRow("cur_rows");

  // Restore saved state
  restoreState();

  // Ensure labels set
  refreshAutoCalcButtons();
  setLang(LANG);

  // Initial compute
  computeCurrent(false);
  computeExpected(false);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
