<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary -->
  <title>AOU GPA Calculator</title>
  <meta name="description" content="AOU GPA Calculator â€“ Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta name="author" content="Homam Shaaban" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://aou-gpa-calculator.github.io/GPA-Calculator/" />

  <!-- Open Graph -->
  <meta property="og:title" content="AOU GPA Calculator" />
  <meta property="og:description" content="Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://aou-gpa-calculator.github.io/GPA-Calculator/" />
  <meta property="og:site_name" content="AOU GPA Calculator" />
  <meta property="og:image" content="https://aou-gpa-calculator.github.io/GPA-Calculator/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="AOU GPA Calculator" />
  <meta name="twitter:description" content="Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta name="twitter:image" content="https://aou-gpa-calculator.github.io/GPA-Calculator/og-image.png" />

  <!-- App polish -->
  <link rel="icon" href="aou-logo.png" />
  <link rel="apple-touch-icon" href="aou-logo.png" />
  <meta name="theme-color" content="#071a2b" />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#071a2b;
      --bg2:#0b2a44;

      --surface: rgba(0, 32, 63, .66);
      --surfaceBorder: rgba(255,255,255,.14);

      --card: rgba(255,255,255,.08);
      --cardBorder: rgba(255,255,255,.18);

      --text:#eaf2ff;
      --muted: rgba(234,242,255,.82);

      --accent:#f7b500;
      --accentHover:#ffd35c;

      --dangerBg: rgba(255,0,0,.18);
      --dangerBorder: rgba(255,140,140,.95);

      --okBg: rgba(46, 204, 113, .14);
      --okBorder: rgba(46, 204, 113, .38);

      --radius: 22px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 10% 10%, rgba(34,193,195,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(247,181,0,.18), transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
    }

    /* RTL tweaks */
    html[dir="rtl"] body { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif; }
    html[dir="rtl"] .tableWrap table { direction: rtl; }
    html[dir="rtl"] th, html[dir="rtl"] td { text-align: right; }
    html[dir="rtl"] select.field{ background-position: left 14px center; }

    .orb{
      position:fixed; width:420px; height:420px; border-radius:999px;
      filter:blur(44px); opacity:.22; pointer-events:none;
      animation: floaty 10s ease-in-out infinite; z-index:0;
    }
    .orb.one{left:-140px; top:90px; background: rgba(34,193,195,.65)}
    .orb.two{right:-180px; top:40px; background: rgba(247,181,0,.55); animation-delay:-3s}
    .orb.three{right:18%; bottom:-240px; width:520px; height:520px; background: rgba(10,93,150,.70); animation-delay:-6s}
    @keyframes floaty{0%,100%{transform:translate(0,0)}50%{transform:translate(10px,-18px)}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

    header{
      text-align:center;
      padding: 24px 16px 6px;
      position:relative;
      z-index:1;
      animation: fadeUp .7s ease-out both;
    }
    header img{
      width:152px;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.25));
    }

    .wrap{
      min-height: calc(100vh - 90px);
      display:flex;
      justify-content:center;
      padding: 12px 16px 54px;
      position:relative;
      z-index:1;
    }

    .app{
      width:min(1100px, 100%);
      background: var(--surface);
      border: 1px solid var(--surfaceBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 22px 18px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      animation: fadeUp .85s ease-out both;
      position: relative;
    }

    .topRow{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    .title{
      text-align:center;
      margin: 8px 0 6px;
      font-size: clamp(24px, 3.2vw, 40px);
      letter-spacing:-.02em;
      font-weight:900;
    }
    .subtitle{
      margin:0 auto 14px;
      text-align:center;
      max-width: 85ch;
      color: var(--muted);
      line-height:1.55;
      font-size:.98rem;
    }

    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      margin: 14px 0 10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:.95rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .chip:hover{ background: rgba(255,255,255,.12); transform: translateY(-1px); }
    .chip[aria-selected="true"]{
      background: rgba(247,181,0,.18);
      border-color: rgba(247,181,0,.32);
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .chip:focus-visible{ outline:3px solid rgba(255,211,92,.55); outline-offset:3px; }

    .tabPanels{ margin-top: 12px; }

    .panel{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
      animation: fadeUp .25s ease-out both;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-45%;
      background: radial-gradient(circle at 18% 18%, rgba(255,255,255,.16), transparent 45%);
      transform: rotate(12deg);
      opacity:.9;
      pointer-events:none;
    }
    .panel > *{ position:relative; z-index:1; }

    .panelTitle{
      margin: 4px 0 6px;
      text-align:center;
      font-size: clamp(18px, 2.2vw, 26px);
      font-weight: 900;
      letter-spacing:-.01em;
    }
    .panelHint{
      margin: 0 auto 12px;
      text-align:center;
      color: var(--muted);
      max-width: 90ch;
      line-height:1.55;
      font-size: .95rem;
    }

    .note{
      margin: 0 auto 12px;
      max-width: 95ch;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--muted);
      line-height: 1.55;
      font-size: .92rem;
      text-align:center;
    }
    .note strong{ color: rgba(234,242,255,.95); }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      flex: 1 1 190px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: var(--accent);
      color:#0b2a44;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, filter .15s ease;
    }
    .btn:hover{ filter: brightness(1.05); background: var(--accentHover); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn:focus-visible{ outline:3px solid rgba(255,211,92,.55); outline-offset:3px; }

    .btn.secondary{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.18);
      font-weight: 900;
    }
    .btn.secondary:hover{ background: rgba(255,255,255,.16); filter:none; }

    .error{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--dangerBg);
      border: 1px solid var(--dangerBorder);
      color: #ffd5d5;
      line-height:1.4;
    }

    .success{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--okBg);
      border: 1px solid var(--okBorder);
      color: rgba(234,242,255,.92);
      line-height:1.4;
    }

    .result{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 8px;
      text-align:center;
    }
    .big{
      font-size: clamp(28px, 4vw, 44px);
      font-weight: 900;
      letter-spacing:-.02em;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      margin: 0 auto;
      width: fit-content;
      flex-wrap:wrap;
    }

    details{ margin-top: 8px; }
    details summary{
      cursor:pointer; user-select:none; font-weight:900;
      color: rgba(234,242,255,.92);
      outline:none;
    }
    details summary:focus-visible{ outline:3px solid rgba(255,211,92,.55); outline-offset:3px; border-radius:10px; }

    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      margin-top: 10px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
      background: rgba(0,0,0,.08);
    }
    th, td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      text-align:left;
      white-space:nowrap;
      vertical-align: middle;
    }
    th{
      font-size: .9rem;
      color: rgba(234,242,255,.90);
      letter-spacing:.01em;
      background: rgba(255,255,255,.06);
    }

    .field{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1.8px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-size: 1rem;
      outline:none;
    }
    .field:focus{
      border-color: rgba(255,211,92,.70);
      box-shadow: 0 0 0 3px rgba(255,211,92,.18);
    }
    .field::placeholder{ color: rgba(234,242,255,.55); }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; }
    input[type=number]{ -moz-appearance:textfield; }

    .tiny{ font-size: .88rem; color: var(--muted); }

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight: 900;
      font-size: .82rem;
    }
    .status.ok{ color: rgba(234,242,255,.88); }
    .status.replaced{
      color: #ffd1d1;
      border-color: rgba(255,140,140,.55);
      background: rgba(255,0,0,.10);
    }

    .iconBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.14); }
    .iconBtn:focus-visible{ outline:3px solid rgba(255,211,92,.55); outline-offset:3px; }
    .iconBtn svg{ width:16px; height:16px; fill: currentColor; }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 760px){
      .app{ padding: 18px 14px 14px; }
      .grid{ grid-template-columns: 1fr; }
      table{ min-width: 920px; }
    }

    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='14' viewBox='0 0 20 20' width='14' xmlns='http://www.w3.org/2000/svg'><path d='M5.516 7.548a.625.625 0 0 1 .884 0L10 11.156l3.6-3.608a.625.625 0 1 1 .884.884l-4.042 4.05a.625.625 0 0 1-.884 0L5.516 8.432a.625.625 0 0 1 0-.884z'/></svg>");
      background-repeat:no-repeat;
      background-position:right 14px center;
      cursor:pointer;
    }
    option{ background:#002b4c; color:#fff; }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 760px){
      .split{ grid-template-columns: 1fr; }
    }

    footer{
      margin-top: 16px;
      text-align:center;
      font-size: .85rem;
      color: var(--muted);
      line-height:1.6;
    }

    /* ======= TOP TOAST (clear copy message) ======= */
    .toastTop{
      position: sticky;
      top: 10px;
      z-index: 50;
      width: min(900px, 100%);
      margin: 0 auto 12px;
      display: none;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(234,242,255,.95);
      font-weight: 800;
      text-align: center;
      box-shadow: 0 14px 36px rgba(0,0,0,.28);
    }
    .toastTop.ok{
      border-color: rgba(46, 204, 113, .50);
      background: rgba(46, 204, 113, .16);
    }
    .toastTop.err{
      border-color: rgba(255,140,140,.70);
      background: rgba(255,0,0,.14);
    }

    /* ===================== Print ===================== */
    @media print{
      body{ background:#fff !important; color:#000 !important; }
      .orb, header, .tabs, .topRow, footer, .btnRow, .iconBtn, .btn, details summary, .note, .toastTop { display:none !important; }
      .app{ box-shadow:none !important; border:none !important; background:#fff !important; color:#000 !important; padding:0 !important; }
      .panel{ background:#fff !important; border:none !important; padding:0 !important; }
      .panel::before{ display:none !important; }
      th,td{ color:#000 !important; border-color:#ddd !important; }
      .field{ border:1px solid #ddd !important; background:#fff !important; color:#000 !important; }
      .status{ border-color:#ddd !important; background:#f6f6f6 !important; color:#000 !important; }
      table{ min-width: 0 !important; width:100% !important; }
      .tableWrap{ border:none !important; }
      th, td{ white-space: normal !important; }
      #tab-current, #tab-forecast{ display:none !important; }
      body[data-print="current"] #tab-current{ display:block !important; }
      body[data-print="forecast"] #tab-forecast{ display:block !important; }
    }

    @media (prefers-reduced-motion: reduce){
      .orb, header, .app, .panel{ animation:none !important; }
      .btn, .chip{ transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="orb one"></div>
  <div class="orb two"></div>
  <div class="orb three"></div>

  <header>
    <img src="aou-logo.png" alt="Arab Open University Logo" />
  </header>

  <div class="wrap">
    <main class="app" role="main" aria-label="AOU GPA Calculator App">

      <!-- TOP CLEAR MESSAGE -->
      <div id="toastTop" class="toastTop" role="status" aria-live="polite"></div>

      <div class="topRow">
        <button class="chip" type="button" id="langToggle" aria-label="Toggle Language">ğŸŒ AR</button>
        <button class="chip" type="button" id="copyLinkBtn" aria-label="Copy share link">ğŸ”— Copy Link</button>
      </div>

      <div class="title" id="appTitle">AOU GPA Calculator</div>
      <p class="subtitle" id="appSubtitle">
        Modern web app to calculate <strong>Current GPA</strong> and forecast <strong>Expected GPA</strong> on a 4.0 scale.
      </p>

      <div class="note" id="officialNote">
        <strong>Disclaimer:</strong> Student-built tool for guidance only. Not an official AOU system.
      </div>

      <div class="tabs" role="tablist" aria-label="GPA Tabs">
        <button class="chip" role="tab" id="tabBtn-current" aria-controls="tab-current" aria-selected="true" data-tab="current">
          ğŸ“˜ Current GPA
        </button>
        <button class="chip" role="tab" id="tabBtn-forecast" aria-controls="tab-forecast" aria-selected="false" data-tab="forecast">
          ğŸ“Š Forecast GPA
        </button>
      </div>

      <div class="tabPanels">
        <!-- CURRENT -->
        <section class="panel" id="tab-current" role="tabpanel" aria-labelledby="tabBtn-current">
          <div class="panelTitle" id="currentTitle">Current GPA Calculator</div>
          <p class="panelHint" id="currentHint">
            Enter <strong>Course Code</strong>, <strong>Grade (0â€“100)</strong>, and <strong>Credit Hours</strong>. GPA updates automatically (you can turn it off).
          </p>

          <div class="note" id="retakeNote">
            <strong>Retake Rule:</strong> If you enter the same <u>Course Code</u> multiple times, only the <strong>latest attempt</strong> is counted (previous attempts become <strong>Replaced</strong>).
          </div>

          <div class="tableWrap" aria-label="Courses table">
            <table>
              <thead>
                <tr>
                  <th style="width:190px;" id="thCode">Course Code</th>
                  <th style="width:210px;" id="thGrade">Grade (0â€“100)</th>
                  <th style="width:180px;" id="thCredits">Credit Hours</th>
                  <th style="width:140px;" id="thPoints">GPA Points</th>
                  <th style="width:170px;" id="thStatus">Status</th>
                  <th style="width:130px;" id="thAction">Action</th>
                </tr>
              </thead>
              <tbody id="current-tbody"></tbody>
            </table>
          </div>

          <div class="btnRow">
            <button class="btn" type="button" id="current-btnAdd">Add Course</button>
            <button class="btn secondary" type="button" id="current-btnCalc">Calculate</button>
            <button class="btn secondary" type="button" id="current-btnAuto">Auto-Calculate: ON</button>
            <button class="btn secondary" type="button" id="current-btnReset">Reset</button>
            <button class="btn secondary" type="button" id="current-btnExport">Export (JSON)</button>
            <label class="btn secondary" style="cursor:pointer;" id="current-importLabel">
              Import (JSON)
              <input id="current-fileImport" type="file" accept="application/json" style="display:none;">
            </label>
            <button class="btn secondary" type="button" id="current-btnPrint">Print Report</button>
          </div>

          <div id="current-error" class="error" role="alert"></div>

          <div class="result" aria-live="polite">
            <div class="big"><span id="current-gpa">0.00</span></div>
            <div class="pill">
              <span id="currentGpaLabel">Current GPA</span>
              <span id="current-merit"></span>
            </div>

            <details>
              <summary id="currentDetailsSummary">Show details</summary>
              <div class="tiny" style="margin-top:10px; line-height:1.65;">
                <div><strong id="currentTotalCHLabel">Total Credit Hours (counted):</strong> <span id="current-totalCH">0</span></div>
                <div><strong id="currentTotalQPLabel">Total Quality Points:</strong> <span id="current-totalQP">0.00</span></div>
                <div class="tiny" style="margin-top:6px;" id="replacedNoteSmall">
                  Rows marked <strong>Replaced</strong> are excluded due to retake replacement.
                </div>
              </div>
            </details>
          </div>
        </section>

        <!-- FORECAST -->
        <section class="panel" id="tab-forecast" role="tabpanel" aria-labelledby="tabBtn-forecast" hidden>
          <div class="panelTitle" id="forecastTitle">Expected GPA Forecast</div>
          <p class="panelHint" id="forecastHint">
            Forecast your final cumulative GPA using completed hours, current GPA, and expected semester performance.
          </p>

          <div class="grid" aria-label="Forecast inputs">
            <div>
              <label class="tiny" for="forecast-completedHours" id="lblCompleted"><strong>Total completed credit hours</strong></label>
              <input class="field" inputmode="numeric" type="number" id="forecast-completedHours" min="0" placeholder="e.g., 60" />
            </div>

            <div>
              <label class="tiny" for="forecast-currentGpa" id="lblCurrentGpa"><strong>Current cumulative GPA (0â€“4)</strong></label>
              <input class="field" inputmode="decimal" type="number" id="forecast-currentGpa" min="0" max="4" step="0.01" placeholder="e.g., 2.75" />
            </div>

            <div>
              <label class="tiny" for="forecast-newHours" id="lblSemHours"><strong>Credit hours this semester</strong></label>
              <input class="field" inputmode="numeric" type="number" id="forecast-newHours" min="1" placeholder="e.g., 15" />
            </div>

            <div>
              <label class="tiny" for="forecast-mode" id="lblMode"><strong>Input type for this semester</strong></label>
              <select class="field" id="forecast-mode">
                <option value="gpa" id="optModeGpa">Expected semester GPA (0â€“4)</option>
                <option value="grade" id="optModeGrade">Expected average grade (0â€“100)</option>
              </select>
            </div>

            <div>
              <label class="tiny" for="forecast-semGpa" id="lblSemGpa"><strong>Expected semester GPA (0â€“4)</strong></label>
              <input class="field" inputmode="decimal" type="number" id="forecast-semGpa" min="0" max="4" step="0.01" placeholder="e.g., 3.20" />
            </div>

            <div>
              <label class="tiny" for="forecast-semGrade" id="lblSemGrade"><strong>Expected average grade (0â€“100)</strong></label>
              <input class="field" inputmode="numeric" type="number" id="forecast-semGrade" min="0" max="100" placeholder="e.g., 85" />
            </div>
          </div>

          <div class="btnRow">
            <button class="btn" type="button" id="forecast-btnCalc">Calculate</button>
            <button class="btn secondary" type="button" id="forecast-btnAuto">Auto-Calculate: ON</button>
            <button class="btn secondary" type="button" id="forecast-btnReset">Reset</button>
            <button class="btn secondary" type="button" id="forecast-btnPrint">Print Report</button>
          </div>

          <div id="forecast-error" class="error" role="alert"></div>

          <div class="result" aria-live="polite">
            <div class="big">
              <span id="forecast-outGpa">â€“</span>
            </div>
            <div class="pill">
              <span id="expectedGpaLabel">Expected GPA</span>
              <span id="forecast-outMerit"></span>
            </div>
          </div>
        </section>
      </div>

      <footer>
        Â© 2025 â€“ AOU GPA Calculator. Developed by Homam Shaaban â€“ Faculty of Computer Studies (Networks &amp; Information Security).<br/>
        <span class="tiny" id="footerNote">Guidance only â€“ does not replace official university records.</span>
      </footer>
    </main>
  </div>

  <script>
    // ========================= helpers =========================
    const $ = (id) => document.getElementById(id);

    function clampNumber(n, min, max){
      if (!Number.isFinite(n)) return n;
      return Math.min(max, Math.max(min, n));
    }

    function convertToGPA(g){
      if (g >= 90) return 4.0;
      if (g >= 82) return 3.5;
      if (g >= 74) return 3.0;
      if (g >= 66) return 2.5;
      if (g >= 58) return 2.0;
      if (g >= 50) return 1.5;
      return 0.0;
    }

    function getMerit(g){
      if (g >= 3.67) return { t:"Excellent", c:"#7CFC00" };
      if (g >= 3.00) return { t:"Very Good", c:"#ADFF2F" };
      if (g >= 2.33) return { t:"Good", c:"#F0E68C" };
      if (g >= 2.00) return { t:"Pass", c:"#FFD700" };
      return { t:"Fail", c:"#FF4C4C" };
    }

    function normalizeCode(code){
      return (code || "").trim().toUpperCase();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ======= TOP TOAST =======
    function toastTop(msg, type="ok"){
      const el = $("toastTop");
      el.className = "toastTop " + (type === "err" ? "err" : "ok");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{
        el.style.display = "none";
        el.textContent = "";
      }, 1800);
      try { el.scrollIntoView({behavior:"smooth", block:"nearest"}); } catch(e){}
    }

    // ========================= Tabs =========================
    function setActiveTab(name){
      const btnCurrent = $("tabBtn-current");
      const btnForecast = $("tabBtn-forecast");
      const panelCurrent = $("tab-current");
      const panelForecast = $("tab-forecast");

      const isCurrent = (name === "current");

      btnCurrent.setAttribute("aria-selected", isCurrent ? "true" : "false");
      btnForecast.setAttribute("aria-selected", !isCurrent ? "true" : "false");

      panelCurrent.hidden = !isCurrent;
      panelForecast.hidden = isCurrent;

      const newHash = isCurrent ? "#current" : "#forecast";
      if (location.hash !== newHash) history.replaceState(null, "", newHash);

      if (!isCurrent) forecastCalculate(true);
      if (isCurrent) currentCalculate(true);
    }

    function initTabs(){
      document.querySelectorAll("[data-tab]").forEach(btn=>{
        btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
      });

      const hash = (location.hash || "").toLowerCase();
      if (hash === "#forecast") setActiveTab("forecast");
      else setActiveTab("current");
    }

    // ========================= Language (EN/AR) =========================
    const LANG_KEY = "aouLangV2";
    function getLang(){
      try{
        const v = localStorage.getItem(LANG_KEY);
        if (v === "ar" || v === "en") return v;
      }catch(e){}
      return "en";
    }
    function setLang(lang){
      const root = document.documentElement;
      root.lang = lang;
      root.dir = (lang === "ar") ? "rtl" : "ltr";
      try{ localStorage.setItem(LANG_KEY, lang); }catch(e){}
      applyI18N(lang);
      $("langToggle").textContent = (lang === "ar") ? "ğŸŒ EN" : "ğŸŒ AR";
    }

    const I18N = {
      en: {
        appTitle:"AOU GPA Calculator",
        appSubtitle:"Modern web app to calculate <strong>Current GPA</strong> and forecast <strong>Expected GPA</strong> on a 4.0 scale.",
        officialNote:"<strong>Disclaimer:</strong> Student-built tool for guidance only. Not an official AOU system.",
        tabCurrent:"ğŸ“˜ Current GPA",
        tabForecast:"ğŸ“Š Forecast GPA",
        copyLink:"ğŸ”— Copy Link",
        linkCopied:"Share link copied.",
        linkCopyFail:"Could not copy link. Copied URL shown in alert.",
        counted:"Counted",
        replaced:"Replaced",
        remove:"Remove",
        invalidGrade:"Invalid grade. Each grade must be between 0 and 100.",
        invalidCredits:"Invalid credit hours. Each course must have positive credit hours.",
        fillFirst:"Please add at least one course and fill values before calculating.",
        resetDone:"Reset done.",
        exportReady:"Export file downloaded.",
        imported:"Imported successfully.",
        autoOn:"Auto-Calculate: ON",
        autoOff:"Auto-Calculate: OFF",
        addCourse:"Add Course",
        calc:"Calculate",
        reset:"Reset",
        export:"Export (JSON)",
        import:"Import (JSON)",
        print:"Print Report",
        currentGpaLabel:"Current GPA",
        details:"Show details",
        totalCH:"Total Credit Hours (counted):",
        totalQP:"Total Quality Points:",
        replacedSmall:`Rows marked <strong>Replaced</strong> are excluded due to retake replacement.`
      },
      ar: {
        appTitle:"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ â€“ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ÙØªÙˆØ­Ø©",
        appSubtitle:"ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¯ÙŠØ« Ù„Ø­Ø³Ø§Ø¨ <strong>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</strong> ÙˆØªÙˆÙ‚Ø¹ <strong>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</strong> Ø¹Ù„Ù‰ Ù…Ù‚ÙŠØ§Ø³ 4.0.",
        officialNote:"<strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø£Ø¯Ø§Ø© Ø·Ù„Ø§Ø¨ÙŠØ© Ù„Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙÙ‚Ø· ÙˆÙ„ÙŠØ³Øª Ù†Ø¸Ø§Ù…Ù‹Ø§ Ø±Ø³Ù…ÙŠÙ‹Ø§ Ù„Ù„Ø¬Ø§Ù…Ø¹Ø©.",
        tabCurrent:"ğŸ“˜ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ",
        tabForecast:"ğŸ“Š ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„",
        copyLink:"ğŸ”— Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·",
        linkCopied:"ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.",
        linkCopyFail:"ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®. ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ØªÙ†Ø¨ÙŠÙ‡.",
        counted:"Ù…Ø­ØªØ³Ø¨",
        replaced:"Ù…Ø³ØªØ¨Ø¯Ù„Ø©",
        remove:"Ø­Ø°Ù",
        invalidGrade:"Ø¯Ø±Ø¬Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100.",
        invalidCredits:"Ø§Ù„Ø³Ø§Ø¹Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§ Ù…ÙˆØ¬Ø¨Ù‹Ø§.",
        fillFirst:"Ø£Ø¶Ù Ù…Ù‚Ø±Ø±Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨.",
        resetDone:"ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·.",
        exportReady:"ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ±.",
        imported:"ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.",
        autoOn:"Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ØªØ´ØºÙŠÙ„",
        autoOff:"Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø¥ÙŠÙ‚Ø§Ù",
        addCourse:"Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø±Ø±",
        calc:"Ø§Ø­Ø³Ø¨",
        reset:"Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·",
        export:"ØªØµØ¯ÙŠØ± (JSON)",
        import:"Ø§Ø³ØªÙŠØ±Ø§Ø¯ (JSON)",
        print:"Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±",
        currentGpaLabel:"Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ",
        details:"Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„",
        totalCH:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª (Ø§Ù„Ù…Ø­ØªØ³Ø¨Ø©):",
        totalQP:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·:",
        replacedSmall:`Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ Ø¹Ù„ÙŠÙ‡Ø§ <strong>Ù…Ø³ØªØ¨Ø¯Ù„Ø©</strong> Ù„Ø§ ØªÙØ­ØªØ³Ø¨ Ø¨Ø³Ø¨Ø¨ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©.`
      }
    };

    function applyI18N(lang){
      const t = I18N[lang];
      $("appTitle").textContent = t.appTitle;
      $("appSubtitle").innerHTML = t.appSubtitle;
      $("officialNote").innerHTML = t.officialNote;

      $("tabBtn-current").textContent = t.tabCurrent;
      $("tabBtn-forecast").textContent = t.tabForecast;
      $("copyLinkBtn").textContent = t.copyLink;

      $("current-btnAdd").textContent = t.addCourse;
      $("current-btnCalc").textContent = t.calc;
      $("current-btnReset").textContent = t.reset;
      $("current-btnExport").textContent = t.export;
      $("current-importLabel").childNodes[0].nodeValue = t.import + " ";
      $("current-btnPrint").textContent = t.print;
      $("currentGpaLabel").textContent = t.currentGpaLabel;
      $("currentDetailsSummary").textContent = t.details;
      $("currentTotalCHLabel").textContent = t.totalCH;
      $("currentTotalQPLabel").textContent = t.totalQP;
      $("replacedNoteSmall").innerHTML = t.replacedSmall;

      $("forecast-btnCalc").textContent = t.calc;
      $("forecast-btnReset").textContent = t.reset;
      $("forecast-btnPrint").textContent = t.print;

      applyAutoButtonTexts();
      refreshRowLabels();
    }

    // ========================= Share Link =========================
    async function copyShareLink(){
      const lang = getLang();
      const active = (location.hash && location.hash.toLowerCase() === "#forecast") ? "forecast" : "current";

      // Ø«Ø§Ø¨Øª Ù„ØµÙØ­Ø© GitHub Pages (Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ù„Ùˆ ØªØºÙŠØ±Øª Ø·Ø±ÙŠÙ‚Ø© ØªÙˆÙ„ÙŠØ¯ origin ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª)
      const base = "https://aou-gpa-calculator.github.io/GPA-Calculator/";
      const url = new URL(base);
      url.hash = active === "forecast" ? "#forecast" : "#current";
      url.searchParams.set("lang", lang);

      const text = url.toString();
      try{
        await navigator.clipboard.writeText(text);
        toastTop(I18N[lang].linkCopied, "ok");
      }catch(e){
        alert(I18N[lang].linkCopyFail + "\n\n" + text);
        toastTop(I18N[lang].linkCopyFail, "err");
      }
    }

    // ========================= Current GPA (Retake Replacement) =========================
    const CURRENT_STORAGE = "aouCurrentStateRetakeV3";
    let currentAuto = true;
    let currentRowId = 0;

    function currentShowError(msg){
      const box = $("current-error");
      box.textContent = msg;
      box.style.display = "block";
    }
    function currentClearError(){
      const box = $("current-error");
      box.textContent = "";
      box.style.display = "none";
    }

    function currentReadRow(tr){
      const [codeEl, gradeEl, creditsEl] = tr.querySelectorAll("input");
      const code = normalizeCode(codeEl.value);

      const gStr = gradeEl.value.trim();
      const cStr = creditsEl.value.trim();

      const grade = (gStr === "") ? null : Number(gStr);
      const credits = (cStr === "") ? null : Number(cStr);

      return { code, grade, credits };
    }

    function currentBuildLastIndex(rows){
      const last = new Map();
      rows.forEach((tr, idx)=>{
        const { code } = currentReadRow(tr);
        if (code) last.set(code, idx);
      });
      return last;
    }

    function currentCreateRow(data = {}){
      currentRowId++;
      const tr = document.createElement("tr");
      tr.dataset.row = String(currentRowId);

      const lang = getLang();
      const t = I18N[lang];

      tr.innerHTML = `
        <td>
          <input class="field" type="text" placeholder="${lang==='ar'?'Ù…Ø«Ø§Ù„: ITC101':'e.g., ITC101'}" value="${escapeHtml(data.code || "")}" aria-label="Course code" />
        </td>
        <td>
          <input class="field" inputmode="numeric" type="number" min="0" max="100" placeholder="${lang==='ar'?'Ù…Ø«Ø§Ù„: 85':'e.g., 85'}" value="${data.grade ?? ""}" aria-label="Course grade" />
        </td>
        <td>
          <input class="field" inputmode="numeric" type="number" min="1" placeholder="${lang==='ar'?'Ù…Ø«Ø§Ù„: 3':'e.g., 3'}" value="${data.credits ?? ""}" aria-label="Credit hours" />
        </td>
        <td class="tiny" data-points>â€“</td>
        <td><span class="status ok" data-status>${t.counted}</span></td>
        <td>
          <button class="iconBtn" type="button" aria-label="Remove course">
            <svg viewBox="0 0 24 24"><path d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9zM7 9h2v10H7V9z"/></svg>
            ${t.remove}
          </button>
        </td>
      `;

      const inputs = tr.querySelectorAll("input");

      inputs.forEach(inp=>{
        inp.addEventListener("input", ()=>{
          if (inp.type === "number" && inp.getAttribute("max") === "100"){
            const v = inp.value.trim();
            if (v !== ""){
              let n = Number(v);
              if (Number.isFinite(n)){
                n = clampNumber(n, 0, 100);
                if (String(n) !== v) inp.value = String(n);
              }
            }
          }
          if (inp.type === "number" && inp.getAttribute("min") === "1" && inp.getAttribute("max") === null){
            const v = inp.value.trim();
            if (v !== ""){
              let n = Number(v);
              if (Number.isFinite(n) && n < 1) inp.value = "1";
            }
          }
          if (currentAuto) currentCalculate(true);
          currentSaveState();
        });

        inp.addEventListener("change", ()=>{
          if (currentAuto) currentCalculate(true);
          currentSaveState();
        });
      });

      tr.querySelector("button").addEventListener("click", ()=>{
        tr.remove();
        if (currentAuto) currentCalculate(true);
        currentSaveState();
      });

      $("current-tbody").appendChild(tr);
      if (currentAuto) currentCalculate(true);
    }

    function currentCalculate(silent=false){
      currentClearError();

      const lang = getLang();
      const t = I18N[lang];

      const rows = Array.from($("current-tbody").querySelectorAll("tr"));
      if (rows.length === 0){
        $("current-gpa").textContent = "0.00";
        $("current-merit").textContent = "";
        $("current-totalCH").textContent = "0";
        $("current-totalQP").textContent = "0.00";
        return;
      }

      const lastIndexByCode = currentBuildLastIndex(rows);

      let totalQP = 0;
      let totalCH = 0;
      let anyFilled = false;

      for (let idx = 0; idx < rows.length; idx++){
        const tr = rows[idx];
        const { code, grade, credits } = currentReadRow(tr);

        const pointsCell = tr.querySelector("[data-points]");
        const statusEl = tr.querySelector("[data-status]");

        const isReplaced = !!code && lastIndexByCode.get(code) !== idx;

        if (isReplaced){
          pointsCell.textContent = "â€“";
          statusEl.textContent = t.replaced;
          statusEl.className = "status replaced";
          continue;
        }

        statusEl.textContent = t.counted;
        statusEl.className = "status ok";

        if (grade !== null || credits !== null || code) anyFilled = true;

        if (grade === null || credits === null){
          pointsCell.textContent = "â€“";
          continue;
        }

        if (!Number.isFinite(grade) || grade < 0 || grade > 100){
          pointsCell.textContent = "â€“";
          if (!silent) currentShowError(t.invalidGrade);
          return;
        }

        if (!Number.isFinite(credits) || credits <= 0){
          pointsCell.textContent = "â€“";
          if (!silent) currentShowError(t.invalidCredits);
          return;
        }

        const gpaPoints = convertToGPA(grade);
        pointsCell.textContent = gpaPoints.toFixed(2);

        totalQP += gpaPoints * credits;
        totalCH += credits;
      }

      if (!anyFilled && !silent){
        currentShowError(t.fillFirst);
        return;
      }

      if (totalCH <= 0){
        $("current-gpa").textContent = "0.00";
        $("current-merit").textContent = "";
        $("current-totalCH").textContent = "0";
        $("current-totalQP").textContent = "0.00";
        return;
      }

      const gpa = totalQP / totalCH;
      $("current-gpa").textContent = gpa.toFixed(2);

      const merit = getMerit(gpa);
      const m = $("current-merit");
      m.textContent = `â€“ ${merit.t}`;
      m.style.color = merit.c;

      $("current-totalCH").textContent = String(totalCH.toFixed(0));
      $("current-totalQP").textContent = totalQP.toFixed(2);
    }

    function currentReset(){
      const lang = getLang();
      $("current-tbody").innerHTML = "";
      currentRowId = 0;
      currentClearError();
      try{ localStorage.removeItem(CURRENT_STORAGE); }catch(e){}
      currentCreateRow();
      currentCalculate(true);
      toastTop(I18N[lang].resetDone, "ok");
    }

    function currentSaveState(){
      const rows = Array.from($("current-tbody").querySelectorAll("tr")).map(tr => currentReadRow(tr));
      try{ localStorage.setItem(CURRENT_STORAGE, JSON.stringify({ rows })); }catch(e){}
    }

    function currentRestoreState(){
      try{
        const raw = localStorage.getItem(CURRENT_STORAGE);
        if (!raw){ currentCreateRow(); return; }
        const data = JSON.parse(raw);
        if (!data.rows || !Array.isArray(data.rows) || data.rows.length === 0){
          currentCreateRow(); return;
        }
        data.rows.forEach(r => currentCreateRow({ code: r.code, grade: r.grade, credits: r.credits }));
        currentCalculate(true);
      }catch(e){
        currentCreateRow();
      }
    }

    function currentExportJSON(){
      const lang = getLang();
      const rows = Array.from($("current-tbody").querySelectorAll("tr")).map(tr => currentReadRow(tr));
      const payload = {
        app: "AOU GPA Calculator",
        module: "Current GPA",
        version: "RetakeReplacement-1.0",
        exportedAt: new Date().toISOString(),
        rows
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "aou-current-gpa-data.json";
      a.click();
      URL.revokeObjectURL(a.href);
      toastTop(I18N[lang].exportReady, "ok");
    }

    function currentImportJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        const lang = getLang();
        try{
          const data = JSON.parse(String(reader.result || ""));
          const rows = data.rows;
          if (!Array.isArray(rows) || rows.length === 0){
            return currentShowError(lang === "ar" ? "ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©." : "Invalid file format.");
          }
          $("current-tbody").innerHTML = "";
          currentRowId = 0;
          rows.forEach(r => currentCreateRow({ code: r.code, grade: r.grade, credits: r.credits }));
          currentCalculate(true);
          currentSaveState();
          toastTop(I18N[lang].imported, "ok");
        }catch(e){
          currentShowError(lang === "ar" ? "Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­." : "Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    }

    function currentPrint(){
      document.body.dataset.print = "current";
      window.print();
    }

    // ========================= Forecast (simple) =========================
    let forecastAuto = true;

    function forecastShowError(msg){
      const box = $("forecast-error");
      box.textContent = msg;
      box.style.display = "block";
    }
    function forecastClearError(){
      const box = $("forecast-error");
      box.textContent = "";
      box.style.display = "none";
    }

    function forecastReadNumber(id){
      const v = $(id).value.trim();
      if (v === "") return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function forecastCalculate(silent=false){
      forecastClearError();

      const completed = forecastReadNumber("forecast-completedHours");
      const currentGpa = forecastReadNumber("forecast-currentGpa");
      const newHours = forecastReadNumber("forecast-newHours");
      const mode = $("forecast-mode").value;

      if (completed === null || currentGpa === null || newHours === null){
        $("forecast-outGpa").textContent = "â€“";
        $("forecast-outMerit").textContent = "";
        return;
      }

      if (Number.isNaN(completed) || completed < 0) return !silent && forecastShowError("Invalid inputs.");
      if (Number.isNaN(currentGpa) || currentGpa < 0 || currentGpa > 4) return !silent && forecastShowError("Invalid inputs.");
      if (Number.isNaN(newHours) || newHours <= 0) return !silent && forecastShowError("Invalid inputs.");

      let semGpa;
      if (mode === "gpa"){
        const sgpa = forecastReadNumber("forecast-semGpa");
        if (sgpa === null) return;
        if (Number.isNaN(sgpa) || sgpa < 0 || sgpa > 4) return !silent && forecastShowError("Invalid inputs.");
        semGpa = sgpa;
      } else {
        const grade = forecastReadNumber("forecast-semGrade");
        if (grade === null) return;
        if (Number.isNaN(grade) || grade < 0 || grade > 100) return !silent && forecastShowError("Invalid inputs.");
        semGpa = convertToGPA(grade);
      }

      const expected = ((completed * currentGpa) + (newHours * semGpa)) / (completed + newHours);
      $("forecast-outGpa").textContent = expected.toFixed(2);

      const merit = getMerit(expected);
      const m = $("forecast-outMerit");
      m.textContent = `â€“ ${merit.t}`;
      m.style.color = merit.c;
    }

    function forecastReset(){
      ["forecast-completedHours","forecast-currentGpa","forecast-newHours","forecast-semGpa","forecast-semGrade"].forEach(id => $(id).value = "");
      $("forecast-mode").value = "gpa";
      $("forecast-outGpa").textContent = "â€“";
      $("forecast-outMerit").textContent = "";
      forecastClearError();
    }

    // ========================= init & wiring =========================
    function applyAutoButtonTexts(){
      const lang = getLang();
      const t = I18N[lang];
      $("current-btnAuto").textContent = currentAuto ? t.autoOn : t.autoOff;
      $("forecast-btnAuto").textContent = forecastAuto ? t.autoOn : t.autoOff;
    }

    function refreshRowLabels(){
      const lang = getLang();
      const t = I18N[lang];
      const rows = Array.from($("current-tbody").querySelectorAll("tr"));
      rows.forEach(tr=>{
        const statusEl = tr.querySelector("[data-status]");
        if (!statusEl) return;
        const isReplaced = statusEl.classList.contains("replaced");
        statusEl.textContent = isReplaced ? t.replaced : t.counted;

        const btn = tr.querySelector("button.iconBtn");
        if (btn){
          const nodes = Array.from(btn.childNodes);
          nodes.forEach(n=>{ if (n.nodeType === Node.TEXT_NODE) n.remove(); });
          btn.insertAdjacentText("beforeend", " " + t.remove);
        }
      });
    }

    function initLanguageFromURLorStorage(){
      const url = new URL(location.href);
      const qLang = (url.searchParams.get("lang") || "").toLowerCase();
      if (qLang === "ar" || qLang === "en") return qLang;
      return getLang();
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      initTabs();

      const initialLang = initLanguageFromURLorStorage();
      setLang(initialLang);
      applyAutoButtonTexts();

      $("langToggle").addEventListener("click", ()=>{
        const next = (getLang() === "en") ? "ar" : "en";
        setLang(next);
      });

      $("copyLinkBtn").addEventListener("click", copyShareLink);

      // Current bindings
      $("current-btnAdd").addEventListener("click", ()=> { currentCreateRow(); currentSaveState(); });
      $("current-btnCalc").addEventListener("click", ()=> currentCalculate(false));
      $("current-btnAuto").addEventListener("click", ()=>{
        currentAuto = !currentAuto;
        applyAutoButtonTexts();
        if (currentAuto) currentCalculate(true);
      });
      $("current-btnReset").addEventListener("click", currentReset);
      $("current-btnExport").addEventListener("click", currentExportJSON);
      $("current-fileImport").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if (f) currentImportJSON(f);
        e.target.value = "";
      });
      $("current-btnPrint").addEventListener("click", currentPrint);

      currentRestoreState();
      currentCalculate(true);

      // Forecast bindings
      $("forecast-mode").addEventListener("change", ()=>{
        const mode = $("forecast-mode").value;
        $("forecast-semGpa").disabled = (mode !== "gpa");
        $("forecast-semGrade").disabled = (mode !== "grade");
        if (mode === "gpa") $("forecast-semGrade").value = "";
        else $("forecast-semGpa").value = "";
        if (forecastAuto) forecastCalculate(true);
      });

      ["forecast-completedHours","forecast-currentGpa","forecast-newHours","forecast-semGpa","forecast-semGrade"].forEach(id=>{
        $(id).addEventListener("input", ()=>{ if (forecastAuto) forecastCalculate(true); });
      });

      $("forecast-btnCalc").addEventListener("click", ()=> forecastCalculate(false));
      $("forecast-btnAuto").addEventListener("click", ()=>{
        forecastAuto = !forecastAuto;
        applyAutoButtonTexts();
        if (forecastAuto) forecastCalculate(true);
      });
      $("forecast-btnReset").addEventListener("click", forecastReset);
      $("forecast-btnPrint").addEventListener("click", ()=>{
        document.body.dataset.print = "forecast";
        window.print();
      });

      // first mode setup
      $("forecast-semGrade").disabled = true;
    });
  </script>
</body>
</html>
