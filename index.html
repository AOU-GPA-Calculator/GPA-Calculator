<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AOU GPA Calculator</title>
  <meta name="theme-color" content="#061b2c">
  <link rel="manifest" href="manifest.json">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#061b2c; --bg2:#0a2b45;
      --card-bg: rgba(255,255,255,.05);
      --border: rgba(255,255,255,.12);
      --text:#eaf2ff; --muted: rgba(234,242,255,.65);
      --gold:#f6b100; --gold2:#ffbf2f;
      --danger:#ff5b5b; --ok:#4ee29a;
      --input-bg: rgba(0,0,0,.25);
      --radius: 16px;
      --blue-header: #2563eb;
      --mono: ui-monospace, monospace;
    }
    html[data-theme="light"]{
      --bg1:#f6f8ff; --bg2:#eef2ff;
      --card-bg: #fff;
      --border: rgba(0,0,0,.10);
      --text:#0b1220; --muted: rgba(11,18,32,.65);
      --input-bg: #f0f2f5;
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Cairo", sans-serif; background: linear-gradient(180deg, var(--bg1), var(--bg2)); color: var(--text); min-height: 100vh; padding-bottom: 60px; }
    .wrap { max-width: 950px; margin: 20px auto; padding: 0 16px; }
    
    /* --- Top Bar --- */
    .topbar { 
        display:flex; flex-direction: column; align-items:center; justify-content: center;
        margin-bottom: 25px; gap: 15px; 
    }
    .brand { display: flex; align-items: center; gap: 15px; justify-content: center; }
    .brand img { height: 60px; width: auto; object-fit: contain; }
    .brand-text { text-align: left; }
    html[dir="rtl"] .brand-text { text-align: right; }
    .brand-text h1 { margin:0; font-size:24px; font-weight:900; line-height: 1.1; color: var(--text); }
    .brand-text p { margin:0; font-size:12px; color:var(--muted); font-weight: 600; }
    
    .btn { padding: 8px 18px; border-radius: 99px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; font-weight: 700; font-size:13px; transition:.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    #btnInstall { display: none; background: var(--text); color: var(--bg1); border-color: var(--text); }

    /* Tabs */
    .mainTabs { display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
    .tab { background:transparent; border:1px solid var(--border); padding:10px 30px; border-radius:12px; color:var(--muted); font-weight:700; cursor:pointer; flex: 1; max-width: 200px; transition: .2s; }
    .tab.active { background:rgba(246,177,0,0.15); color:var(--gold); border-color:var(--gold); }
    
    .panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    
    /* Mode Switch */
    .modeSwitch { display:flex; gap:10px; margin-bottom:25px; background:rgba(0,0,0,0.2); padding:5px; border-radius:12px; }
    .modeBtn { flex:1; padding:12px; border-radius:10px; border:none; background:transparent; color:var(--muted); font-weight:800; cursor:pointer; transition: .2s; }
    .modeBtn.active { background:var(--card-bg); color:var(--text); box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    
    /* Inputs & Labels */
    .input-group { margin-bottom: 5px; }
    .fixed-label { display: block; font-size: 13px; font-weight: 800; color: var(--gold); margin-bottom: 8px; text-align: left; }
    html[dir="rtl"] .fixed-label { text-align: right; }

    input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); text-align: center; font-weight: 700; outline: none; font-size:16px; transition: all 0.2s; }
    input:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(246,177,0,0.2); }
    input.code-input { text-transform: uppercase; font-family: var(--mono); }

    /* --- FIX: ABSOLUTE POSITIONING FOR PREVIEW --- */
    .cell-grade {
        position: relative; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¦Ù… */
    }
    .grade-preview {
        position: absolute; /* ØªØ¹ÙˆÙŠÙ… Ø§Ù„Ù†Øµ */
        bottom: -22px;      /* Ø¥Ù†Ø²Ø§Ù„Ù‡ ØªØ­Øª Ø§Ù„Ù…Ø±Ø¨Ø¹ */
        left: 0;
        width: 100%;
        font-size: 11px;
        font-weight: 800;
        text-align: center;
        opacity: 0;
        transition: all 0.2s;
        pointer-events: none; /* Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØºØ·ÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ø´ÙŠØ¡ ØªØ­ØªÙ‡ */
    }
    .grade-preview.show { opacity: 1; bottom: -20px; }
    
    /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¯Ø±Ø¬Ø§Øª */
    .grade-preview.excellent { color: var(--gold) !important; }   /* A, B+ (Ø°Ù‡Ø¨ÙŠ) */
    .grade-preview.good { color: var(--ok) !important; }          /* B, C+, C (Ø£Ø®Ø¶Ø±) */
    .grade-preview.warn { color: #ff9f43 !important; }            /* D (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) */
    .grade-preview.bad { color: var(--danger) !important; }       /* F (Ø£Ø­Ù…Ø±) */

    /* --- GRID SYSTEM --- */
    .thead { 
        display: grid; 
        grid-template-columns: 1.5fr 1fr 1fr 100px 60px; 
        gap: 15px; 
        padding: 0 10px 15px; 
        border-bottom: 1px solid var(--border); 
        margin-bottom: 10px;
        font-size: 13px; font-weight: 800; color: var(--muted); text-align: center; 
    }
    
    .trow { 
        display: grid; 
        grid-template-columns: 1.5fr 1fr 1fr 100px 60px; 
        gap: 15px; 
        align-items: center; /* Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø³ØªÙƒÙˆÙ† Ù…Ø­Ø§Ø°ÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹ */
        padding: 10px 0; 
        border-bottom: 1px solid var(--border); 
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    @media (min-width: 769px) {
        .mobile-wrapper { display: contents; } 
        .cell-code { order: 1; }
        .cell-hours { order: 2; }
        .cell-grade { order: 3; }
        .cell-status { order: 4; }
        .cell-del { order: 5; }
        .mobile-label { display: none !important; }
    }

    /* Badges & Buttons */
    .badge { display:flex; align-items:center; justify-content:center; height: 40px; border-radius:10px; font-size:12px; font-weight:800; width:100%; }
    .badge.ok { background:rgba(78,226,154,0.1); color:var(--ok); border:1px solid rgba(78,226,154,0.2); }
    .badge.dup { background:rgba(255,91,91,0.1); color:var(--danger); text-decoration:line-through; opacity:0.8; border:1px solid rgba(255,91,91,0.2); }
    
    .btn-del { width:100%; height:45px; border-radius:12px; border:1px solid rgba(255,91,91,0.3); background:rgba(255,91,91,0.1); color:var(--danger); cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; transition:.2s; }
    .btn-del:hover { background:var(--danger); color:#fff; }

    /* --- MOBILE VIEW --- */
    .mobile-label { display: none; } 
    @media (max-width: 768px) {
        .thead { display: none !important; }
        
        .trow {
            display: flex; flex-direction: column; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            gap: 15px; 
            margin-bottom: 15px;
        }
        html[data-theme="light"] .trow { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .mobile-label { display: block; font-size: 13px; font-weight: 800; margin-bottom: 8px; color: var(--gold); text-align: left; }
        html[dir="rtl"] .mobile-label { text-align: right; }

        .cell-code { width: 100%; order: 1; }
        .mobile-wrapper { display: flex; gap: 15px; width: 100%; order: 2; }
        .cell-half { flex: 1; }
        .cell-status { width: 100%; order: 3; display: none; }
        .cell-del { width: 100%; order: 4; margin-top: 5px; }
        
        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .grade-preview { bottom: 2px; right: 10px; text-align: right; width: auto; pointer-events: none;}
        html[dir="rtl"] .grade-preview { right: auto; left: 10px; text-align: left; }
        
        .brand img { height: 50px; }
    }

    /* Results */
    .big-actions { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; }
    .btn-block { width: 100%; padding: 16px; border-radius: 99px; font-weight: 900; font-size: 16px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: .2s; }
    .btn-block:active { transform: scale(0.98); }
    .btn-yellow { background: linear-gradient(180deg, var(--gold2), var(--gold)); color: #1b1400; box-shadow: 0 4px 20px rgba(246,177,0,0.3); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }

    .results-area { text-align: center; margin-top: 35px; padding-top: 25px; border-top: 1px solid var(--border); }
    .res-num { font-size: 64px; font-weight: 900; line-height: 1; margin-bottom: 5px; letter-spacing: -2px; color: var(--text); }
    .res-label { font-size: 14px; color: var(--muted); font-weight: 700; letter-spacing: 1px; margin-bottom: 15px; }
    .res-badge { display: inline-block; padding: 10px 30px; border-radius: 12px; border: 1px solid var(--gold); color: var(--gold); background: rgba(246,177,0,0.1); font-weight: 900; font-size: 14px; }
    
    .hidden { display: none !important; }

    /* Rules & Warning */
    .ruleBox { margin: 14px 0 0; border-radius: 16px; border: 1px solid var(--border); background: rgba(255,255,255,.06); padding: 15px; color: var(--muted); font-size: 13px; line-height: 1.6; text-align: center; font-weight: 700; }
    html[data-theme="light"] .ruleBox { background: rgba(255,255,255,.70); }
    .ruleNote { font-size: 12px; color: var(--danger); margin-top: 8px; display: block; opacity: 0.9; }
    .dupWarning { margin-top:12px; padding:12px; background:rgba(246,177,0,0.1); border:1px solid var(--gold); border-radius:10px; color:var(--gold); font-size:13px; text-align:center; animation: popIn 0.3s; }
    @keyframes popIn { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }

    /* Info Panel Styles */
    .info-header { text-align:center; margin-bottom:25px; }
    .info-header h2 { margin:0; font-size:24px; font-weight:900; color:var(--text); }
    .info-section { margin-bottom:30px; }
    .info-title { display:flex; align-items:center; gap:8px; font-weight:900; font-size:16px; margin-bottom:15px; color:var(--gold); }
    .info-box { background:rgba(255,255,255,0.04); padding:20px; border-radius:16px; border:1px solid var(--border); font-size:14px; line-height:1.7; color:var(--muted); }

    .info-table { width:100%; border-collapse:collapse; font-size:13px; font-weight:700; overflow:hidden; border-radius:12px; margin-bottom:10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .info-table th { background:var(--blue-header); color:#fff; padding:14px; text-align:center; border-bottom:1px solid var(--border); }
    .info-table td { padding:12px; text-align:center; border-bottom:1px solid var(--border); color:var(--text); background: rgba(255,255,255,0.02); }
    .info-table tr:last-child td { border-bottom:none; }
    
    details { margin-bottom:10px; border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:0.3s; background: rgba(255,255,255,0.02); }
    details[open] { background:rgba(255,255,255,0.05); border-color:var(--gold); }
    summary { padding:15px; cursor:pointer; font-weight:800; list-style:none; display:flex; justify-content:space-between; align-items:center; color: var(--text); }
    summary::after { content: '+'; font-size:18px; color:var(--gold); font-weight: 900; }
    details[open] summary::after { content: '-'; }
    .faq-content { padding:15px; font-size:13px; line-height:1.7; color:var(--muted); border-top:1px solid var(--border); }

    .footer { text-align:center; font-size:12px; color:var(--muted); margin-top:40px; line-height:1.6; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; display:flex; align-items:center; justify-content:center; padding:20px; }
    .modal-box { background:var(--bg1); padding:30px; border-radius:20px; max-width:400px; text-align:center; border:1px solid var(--border); }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--ok); color: #000; padding: 10px 24px; border-radius: 30px; font-weight: 800; z-index: 1000; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  </style>
</head>

<body>
    
  <div class="modal" id="disclaimerModal">
    <div class="modal-box">
      <h2 style="color:var(--gold); margin-top:0;">âš ï¸ Disclaimer</h2>
      <p style="font-size:14px; line-height:1.6;">This tool is for guidance only.<br>Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù„Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙÙ‚Ø·.</p>
      <button class="btn btn-yellow" style="padding:10px 30px;" onclick="document.getElementById('disclaimerModal').style.display='none'">I Understand / ÙÙ‡Ù…Øª</button>
    </div>
  </div>

  <div class="toast" id="toast">Saved âœ…</div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img src="aou-logo.png" alt="AOU" onerror="this.src='https://www.aou.edu.kw/images/aou_logo.png'">
        <div class="brand-text">
            <h1>AOU GPA</h1>
            <p>Student Calculator</p>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="btnInstall">ğŸ“² Install</button>
        <button class="btn" onclick="toggleTheme()">ğŸŒ—</button>
        <button class="btn" onclick="toggleLang()">EN/AR</button>
      </div>
    </div>

    <div class="mainTabs">
      <button class="tab active" id="tab1" onclick="switchTab('calc')">Calculator</button>
      <button class="tab" id="tab2" onclick="switchTab('info')">Info</button>
    </div>

    <div class="panel" id="panelCalc">
      <div class="modeSwitch">
        <button class="modeBtn active" id="btnCurr" onclick="setMode('current')">Current / ÙØµÙ„ÙŠ</button>
        <button class="modeBtn" id="btnExp" onclick="setMode('expected')">Cumulative / ØªØ±Ø§ÙƒÙ…ÙŠ</button>
      </div>

      <div id="prevData" class="hidden" style="margin-bottom: 20px; border-bottom:1px solid var(--border); padding-bottom:20px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
              <div class="input-group">
                  <label class="fixed-label" data-i18n="prevGpa">Previous GPA / Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</label>
                  <input type="number" id="prevGpa" step="0.01" placeholder="Ex: 2.85">
              </div>
              <div class="input-group">
                  <label class="fixed-label" data-i18n="prevHours">Completed Hours / Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</label>
                  <input type="number" id="prevHours" step="1" placeholder="Ex: 60">
              </div>
          </div>
      </div>

      <div class="ruleBox">
        <span data-i18n="rule">Retake Rule: Latest attempt counts, previous are Replaced.</span>
        <span class="ruleNote" data-i18n="retakeNote">* Note: According to AOU regulations, retaking a course is not permitted if the previous grade was 'B' or higher.</span>
        <div class="dupWarning" id="dupBox" style="display:none;">
            âš ï¸ <span data-i18n="dupWarning">Important: You cannot register the same course twice in the same semester. Duplicates here are treated as Retakes.</span>
        </div>
      </div>

      <div class="thead" style="margin-top:20px;">
        <div data-lang="code">Course Code</div>
        <div data-lang="hours">Credit Hours</div>
        <div data-lang="grade">Grade (100)</div>
        <div data-lang="status">Status</div>
        <div>Del</div>
      </div>

      <div id="rowsArea" class="table-container"></div>

      <div class="big-actions">
          <button class="btn-block btn-yellow" onclick="addRow()">+ Add Course / Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
              <button class="btn-block btn-outline" onclick="resetAll()">Reset / Ù…Ø³Ø­</button>
              <button class="btn-block btn-yellow" onclick="compute()">Calculate / Ø§Ø­Ø³Ø¨</button>
          </div>
      </div>

      <div class="results-area">
          <div class="res-num" id="semGpa">0.00</div>
          <div class="res-label" data-lang="semGpa">SEMESTER GPA</div>
          <div id="semRank" class="res-badge hidden">Excellent</div>

          <div id="cumBlock" class="hidden" style="margin-top:35px; padding-top:25px; border-top:1px dashed var(--border);">
              <div class="res-num" id="cumGpa" style="font-size:50px;">0.00</div>
              <div class="res-label" data-lang="cumGpa">CUMULATIVE GPA</div>
              <div id="cumRank" class="res-badge hidden">Excellent</div>
          </div>
      </div>
    </div>

    <div class="panel hidden" id="panelInfo">
        <div class="info-header">
            <h2 data-i18n="infoTitle">Information & Guide</h2>
        </div>

        <div class="info-section">
            <div class="info-title">â„¹ï¸ <span data-i18n="aboutTitle">About</span></div>
            <div class="info-box">
               <span data-i18n="aboutText">This tool helps AOU students calculate Semester GPA and forecast Cumulative GPA.</span>
            </div>
        </div>

        <div class="info-section">
            <div class="info-title">ğŸ“ <span data-i18n="scaleTitle">Grading Scale</span></div>
            <table class="info-table">
                <thead>
                    <tr>
                        <th data-i18n="percentHead">Percentage</th>
                        <th data-i18n="pointsHead">Points</th>
                        <th data-i18n="gradeHead">Grade</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>90-100%</td><td>4.0</td><td>A</td></tr>
                    <tr><td>82-89%</td><td>3.5</td><td>B+</td></tr>
                    <tr><td>74-81%</td><td>3.0</td><td>B</td></tr>
                    <tr><td>66-73%</td><td>2.5</td><td>C+</td></tr>
                    <tr><td>58-65%</td><td>2.0</td><td>C</td></tr>
                    <tr><td>50-57%</td><td>1.5</td><td>D</td></tr>
                    <tr><td>Below 50%</td><td>0.0</td><td>F</td></tr>
                </tbody>
            </table>
        </div>

        <div class="info-section">
            <div class="info-title">ğŸ† <span data-i18n="ranksTitle">Graduation Ranks & Honors</span></div>
            <table class="info-table">
                <thead>
                    <tr>
                        <th data-i18n="rankHead">Rank</th>
                        <th data-i18n="estHead">Estimation</th>
                        <th data-i18n="cumHead">Cumulative GPA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>1</td><td data-i18n="est1">Excellent</td><td>3.50 â€“ 4.00</td></tr>
                    <tr><td>2</td><td data-i18n="est2">Very Good</td><td>2.75 â€“ 3.49</td></tr>
                    <tr><td>3</td><td data-i18n="est3">Good</td><td>2.00 â€“ 2.74</td></tr>
                    <tr><td>4</td><td data-i18n="est4">Not Graduated</td><td>&lt; 2.00</td></tr>
                </tbody>
            </table>
        </div>

        <div class="info-section">
            <div class="info-title">â“ <span data-i18n="faqTitle">FAQ</span></div>
            
            <details>
                <summary data-i18n="q1">How to use?</summary>
                <div class="faq-content" data-i18n="a1">Enter your previous GPA/Hours...</div>
            </details>
            
            <details>
                <summary data-i18n="q2">Retakes?</summary>
                <div class="faq-content" data-i18n="a2">Duplicate courses are treated as retakes...</div>
            </details>
            
            <details>
                <summary data-i18n="q3">Official?</summary>
                <div class="faq-content" data-i18n="a3">No, this is a guidance tool...</div>
            </details>
        </div>
    </div>

    <div class="footer" style="margin-top: 50px; padding-bottom: 20px;">
        <div style="margin-bottom: 12px; opacity: 0.7;">
            Â© <span id="yr"></span> AOU Calculator | Unofficial Student Initiative | <span>v1.0</span>
        </div>
        <div style="margin-bottom: 6px;">
            Designed & Developed by: <strong style="color:var(--text); font-size: 13px;">Eng. Homam Ahmad Shaaban</strong>
        </div>
        <div>
            Under Supervision of the Dean of FCS: <strong style="color:var(--text); font-size: 13px;">Dr. Omar Abdulkader</strong>
        </div>
    </div>
  </div>

<script>
let LANG = 'en';
let MODE = 'current';
const STORAGE_KEY = "aou_gpa_v10_fix"; // Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒØ§Ø´

const TEXT = {
    en: { 
        hours: "Credit Hours", grade: "Grade (100)", code: "Course Code", status: "Status", semGpa: "SEMESTER GPA", cumGpa: "CUMULATIVE GPA", counted: "Counted", dup: "Replaced",
        rule: "Retake Rule: Latest attempt counts, previous are Replaced.",
        retakeNote: "* Note: According to AOU regulations, retaking a course is not permitted if the previous grade was 'B' or higher.",
        dupWarning: "Important: You cannot register the same course twice in the same semester. Duplicates here are treated as Retakes.",
        prevGpa: "Previous GPA", prevHours: "Completed Hours",
        infoTitle: "Information & Guide", aboutTitle: "About", aboutText: "Student tool for GPA calculation.",
        scaleTitle: "Grading Scale", gradeHead: "Grade", pointsHead: "Points", percentHead: "Percentage",
        ranksTitle: "Ranks & Honors", rankHead: "Rank", estHead: "Estimation", cumHead: "Cumulative GPA",
        est1: "Excellent", est2: "Very Good", est3: "Good", est4: "Not Graduated",
        faqTitle: "FAQ", q1: "How to use?", a1: "Fill details and click Calculate.", q2: "Retakes?", a2: "Latest grade counts.", q3: "Official?", a3: "No, this is a student tool."
    },
    ar: { 
        hours: "Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª", grade: "Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù…Ù† 100)", code: "Ø§Ø³Ù…/ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø¯Ø©", status: "Ø§Ù„Ø­Ø§Ù„Ø©", semGpa: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ", cumGpa: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ", counted: "Ù…Ø­ØªØ³Ø¨", dup: "Ù…ÙƒØ±Ø±",
        rule: "Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©: ÙŠÙØ­Ø³Ø¨ Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù…Ù‚Ø±Ø± ÙÙ‚Ø·.",
        retakeNote: "* Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­Ø³Ø¨ Ù„ÙˆØ§Ø¦Ø­ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©ØŒ Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø±Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© 'B' Ø£Ùˆ Ø£Ø¹Ù„Ù‰.",
        dupWarning: "ØªÙ†Ø¨ÙŠÙ‡: Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ§Ù‹ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø±ØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØµÙ„. Ø§Ù„ØªÙƒØ±Ø§Ø± Ù‡Ù†Ø§ Ù„ØºØ±Ø¶ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© ÙÙ‚Ø·.",
        prevGpa: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚", prevHours: "Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©",
        infoTitle: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", aboutTitle: "Ø­ÙˆÙ„ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©", aboutText: "Ø£Ø¯Ø§Ø© Ø·Ù„Ø§Ø¨ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„.",
        scaleTitle: "Ø³Ù„Ù… Ø§Ù„Ø¯Ø±Ø¬Ø§Øª", gradeHead: "Ø§Ù„Ø¯Ø±Ø¬Ø©", pointsHead: "Ø§Ù„Ù†Ù‚Ø§Ø·", percentHead: "Ø§Ù„Ù†Ø³Ø¨Ø©",
        ranksTitle: "Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª", rankHead: "Ø§Ù„Ø±ØªØ¨Ø©", estHead: "Ø§Ù„ØªÙ‚Ø¯ÙŠØ±", cumHead: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ",
        est1: "Ù…Ù…ØªØ§Ø²", est2: "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹", est3: "Ø¬ÙŠØ¯", est4: "Ù„Ø§ ÙŠØªÙ… ØªØ®Ø±ÙŠØ¬Ù‡",
        faqTitle: "Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©", q1: "ÙƒÙŠÙ Ø£Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ø³Ø¨Ø©ØŸ", a1: "Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ§Ø­Ø³Ø¨.", q2: "Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©ØŸ", a2: "ØªØ­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø«.", q3: "Ø±Ø³Ù…ÙŠØŸ", a3: "Ù„Ø§ØŒ Ø£Ø¯Ø§Ø© Ø·Ù„Ø§Ø¨ÙŠØ©."
    }
};

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('yr').textContent = new Date().getFullYear();
    if(!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark');
    applyTheme(localStorage.getItem('theme'));
    restoreState();
    
    let deferredPrompt;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e; btnInstall.style.display = 'inline-flex';
    });
    btnInstall.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null; 
        }
    });
});

function rowTemplate(data = {}){
    const code = data.code ?? "";
    const score = (data.score ?? "") === "" ? "" : String(data.score);
    const hours = (data.hours ?? "") === "" ? "" : String(data.hours);

    const div = document.createElement('div');
    div.className = 'trow';
    div.innerHTML = `
        <div class="cell-del">
            <button class="btn-del" onclick="removeRow(this)">âœ•</button>
        </div>
        
        <div class="mobile-wrapper">
             <div class="cell-half cell-hours">
                <span class="mobile-label">${LANG==='ar'?'Ø§Ù„Ø³Ø§Ø¹Ø§Øª (Hours)':'Credit Hours'}</span>
                <input type="number" data-act="hours" placeholder="3" min="1" max="12" value="${hours}">
             </div>
             <div class="cell-half cell-grade">
                <span class="mobile-label">${LANG==='ar'?'Ø§Ù„Ø¯Ø±Ø¬Ø© (Grade)':'Grade (100)'}</span>
                <input type="number" data-act="score" placeholder="88" min="0" max="100" step="0.01" value="${score}">
                <span class="grade-preview"></span>
             </div>
        </div>
        
        <div class="cell-code">
            <span class="mobile-label">${LANG==='ar'?'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Code)':'Course Code'}</span>
            <input type="text" data-act="code" class="code-input" placeholder="GR101" value="${code}">
        </div>
        
        <div class="cell-status">
            <span class="badge ok" data-act="status">---</span>
        </div>
    `;
    
    const scoreInput = div.querySelector('[data-act="score"]');
    
    // 1. ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†)
    scoreInput.addEventListener('input', function(){
        updatePreview(this);
        saveState();
    });

    // 2. Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© (Change/Blur)
    scoreInput.addEventListener('change', function(){
        if(this.value !== ""){
            let val = parseFloat(this.value);
            if(!isNaN(val)){
                this.value = val.toFixed(2); // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø±Ù‚Ù…ÙŠÙ† Ø¹Ø´Ø±ÙŠÙŠÙ†
                updatePreview(this); 
            }
        }
        saveState();
    });

    if(score) updatePreview(scoreInput);

    div.querySelectorAll('input:not([data-act="score"])').forEach(inp => inp.addEventListener('input', () => { saveState(); }));
    
    return div;
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
function updatePreview(input){
    const previewEl = input.nextElementSibling; 
    const val = parseFloat(input.value);
    
    // Reset Classes
    previewEl.className = 'grade-preview show';

    if(isNaN(val) || input.value === ""){
        previewEl.textContent = "";
        previewEl.classList.remove('show');
        return;
    }

    const result = getGradeInfo(val);
    previewEl.textContent = `${result.letter} | ${result.points.toFixed(2)}`;
    
    // Apply Colors based on Points
    if(result.points >= 3.5) {
        previewEl.classList.add('excellent'); // Gold (A, B+)
    } else if (result.points >= 2.0) {
        previewEl.classList.add('good');      // Green (B, C)
    } else if (result.points >= 1.5) {
        previewEl.classList.add('warn');      // Orange (D)
    } else {
        previewEl.classList.add('bad');       // Red (F)
    }
}

function getGradeInfo(score){
    if (score >= 90) return { points: 4.0, letter: 'A' };
    if (score >= 82) return { points: 3.5, letter: 'B+' };
    if (score >= 74) return { points: 3.0, letter: 'B' };
    if (score >= 66) return { points: 2.5, letter: 'C+' };
    if (score >= 58) return { points: 2.0, letter: 'C' };
    if (score >= 50) return { points: 1.5, letter: 'D' };
    return { points: 0.0, letter: 'F' };
}

function addRow(data){
    const div = rowTemplate(data);
    document.getElementById('rowsArea').appendChild(div);
}

function removeRow(btn){
    btn.parentElement.parentElement.remove();
    if(document.getElementById('rowsArea').children.length === 0) addRow();
    saveState();
    compute();
}

function compute(){
    const rows = Array.from(document.getElementById('rowsArea').children);
    const parsed = rows.map((row, idx) => {
        const codeVal = row.querySelector('[data-act="code"]').value.trim().toUpperCase();
        let scoreVal = parseFloat(row.querySelector('[data-act="score"]').value);
        const hoursVal = parseFloat(row.querySelector('[data-act="hours"]').value);
        return { idx, row, code: codeVal, score: scoreVal, hours: hoursVal };
    });

    const lastSeen = new Map();
    parsed.forEach(p => { if(p.code) lastSeen.set(p.code, p.idx); });

    let totalPts = 0; let totalHrs = 0; let hasDuplicate = false;

    parsed.forEach(p => {
        const statusEl = p.row.querySelector('[data-act="status"]');
        if(!p.code || isNaN(p.score) || isNaN(p.hours)){
            statusEl.textContent = '---'; statusEl.className='badge'; return;
        }
        const isLatest = lastSeen.get(p.code) === p.idx;
        if(isLatest){
            const gp = getGradeInfo(p.score).points;
            totalHrs += p.hours;
            totalPts += (gp * p.hours);
            statusEl.textContent = (LANG==='ar' ? TEXT.ar.counted : TEXT.en.counted);
            statusEl.className = 'badge ok';
        } else {
            hasDuplicate = true;
            statusEl.textContent = (LANG==='ar' ? TEXT.ar.dup : TEXT.en.dup);
            statusEl.className = 'badge dup';
        }
    });

    const dupBox = document.getElementById('dupBox');
    if(dupBox) dupBox.style.display = hasDuplicate ? 'block' : 'none';

    const semGpa = totalHrs ? (totalPts / totalHrs) : 0;
    document.getElementById('semGpa').textContent = semGpa.toFixed(2);
    showRank('semRank', semGpa);

    if(MODE === 'expected'){
        const pG = parseFloat(document.getElementById('prevGpa').value) || 0;
        const pH = parseFloat(document.getElementById('prevHours').value) || 0;
        const finalHrs = totalHrs + pH;
        const finalPts = totalPts + (pG * pH);
        const cumGpa = finalHrs ? (finalPts / finalHrs) : 0;
        document.getElementById('cumGpa').textContent = cumGpa.toFixed(2);
        showRank('cumRank', cumGpa);
    }
}

function showRank(elId, gpa){
    const el = document.getElementById(elId);
    el.classList.remove('hidden');
    if(gpa >= 3.50) el.textContent = LANG==='ar'?"Ù…Ù…ØªØ§Ø²":"Excellent";
    else if(gpa >= 2.75) el.textContent = LANG==='ar'?"Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹":"Very Good";
    else if(gpa >= 2.00) el.textContent = LANG==='ar'?"Ø¬ÙŠØ¯":"Good";
    else el.textContent = LANG==='ar'?"Ù„Ø§ ÙŠØªÙ… ØªØ®Ø±ÙŠØ¬Ù‡":"Not Graduated"; 
}

function saveState(){
    const rows = Array.from(document.getElementById('rowsArea').children).map(row => ({
        code: row.querySelector('[data-act="code"]').value,
        score: row.querySelector('[data-act="score"]').value,
        hours: row.querySelector('[data-act="hours"]').value
    }));
    const state = {
        mode: MODE,
        prevGpa: document.getElementById('prevGpa').value,
        prevHours: document.getElementById('prevHours').value,
        rows: rows
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    showToast("Saved âœ…");
}

function restoreState(){
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) { addRow(); return; }
        const st = JSON.parse(raw);
        if(st.mode) setMode(st.mode);
        if(st.prevGpa) document.getElementById('prevGpa').value = st.prevGpa;
        if(st.prevHours) document.getElementById('prevHours').value = st.prevHours;
        document.getElementById('rowsArea').innerHTML = '';
        if(st.rows && st.rows.length > 0) st.rows.forEach(r => addRow(r));
        else addRow();
        compute();
    } catch(e) { addRow(); }
}

function resetAll(){
    if(confirm('Clear all fields?')){
        document.getElementById('rowsArea').innerHTML = '';
        addRow();
        document.getElementById('prevGpa').value = '';
        document.getElementById('prevHours').value = '';
        document.getElementById('semGpa').textContent = '0.00';
        document.getElementById('cumGpa').textContent = '0.00';
        saveState();
    }
}

function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(() => t.style.display='none', 1500);
}

function toggleTheme(){
    const current = document.documentElement.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
}
function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
}

function setMode(m){
    MODE = m;
    document.getElementById('btnCurr').classList.toggle('active', m==='current');
    document.getElementById('btnExp').classList.toggle('active', m==='expected');
    if(m==='expected'){
        document.getElementById('prevData').classList.remove('hidden');
        document.getElementById('cumBlock').classList.remove('hidden');
    } else {
        document.getElementById('prevData').classList.add('hidden');
        document.getElementById('cumBlock').classList.add('hidden');
    }
    saveState(); compute();
}

function toggleLang(){
    LANG = (LANG === 'en') ? 'ar' : 'en';
    document.documentElement.dir = (LANG === 'ar') ? 'rtl' : 'ltr';
    const els = document.querySelectorAll('[data-i18n]');
    els.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(TEXT[LANG][key]) el.textContent = TEXT[LANG][key];
    });
    
    // Header Updates
    document.querySelector('[data-lang="hours"]').textContent = TEXT[LANG].hours;
    document.querySelector('[data-lang="grade"]').textContent = TEXT[LANG].grade;
    document.querySelector('[data-lang="code"]').textContent = TEXT[LANG].code;
    document.querySelector('[data-lang="status"]').textContent = TEXT[LANG].status;
    document.querySelector('[data-lang="semGpa"]').textContent = TEXT[LANG].semGpa;
    document.querySelector('[data-lang="cumGpa"]').textContent = TEXT[LANG].cumGpa;

    // Mobile Labels
    const rows = document.querySelectorAll('.trow');
    rows.forEach(row => {
        row.querySelector('.cell-hours .mobile-label').textContent = LANG==='ar'?'Ø§Ù„Ø³Ø§Ø¹Ø§Øª (Hours)':'Credit Hours';
        row.querySelector('.cell-grade .mobile-label').textContent = LANG==='ar'?'Ø§Ù„Ø¯Ø±Ø¬Ø© (Grade)':'Grade (100)';
        row.querySelector('.cell-code .mobile-label').textContent = LANG==='ar'?'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Code)':'Course Code';
    });
    compute();
}

function switchTab(t){
    document.getElementById('panelCalc').classList.toggle('hidden', t!=='calc');
    document.getElementById('panelInfo').classList.toggle('hidden', t!=='info');
    document.getElementById('tab1').classList.toggle('active', t==='calc');
    document.getElementById('tab2').classList.toggle('active', t==='info');
}

document.getElementById('prevGpa').addEventListener('input', () => { saveState(); compute(); });
document.getElementById('prevHours').addEventListener('input', () => { saveState(); compute(); });
</script>
</body>
</html>
