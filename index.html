<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Primary -->
  <title>AOU GPA Calculator</title>
  <meta name="description" content="AOU GPA Calculator ‚Äì Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta name="author" content="Homam Shaaban" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://aou-gpa-calculator.github.io/GPA-Calculator/" />

  <!-- Open Graph -->
  <meta property="og:title" content="AOU GPA Calculator" />
  <meta property="og:description" content="Calculate Current GPA and Forecast Expected GPA on a 4.0 scale." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://aou-gpa-calculator.github.io/GPA-Calculator/" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#061b2c;
      --bg2:#0a2b45;

      --card1: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);

      --text:#eaf2ff;
      --muted: rgba(234,242,255,.72);

      --gold:#f6b100;
      --gold2:#ffbf2f;

      --shadow: 0 14px 40px rgba(0,0,0,.28);
      --radius: 20px;

      --input: rgba(255,255,255,.10);
      --inputBorder: rgba(255,255,255,.16);

      --danger:#ff5b5b;
      --ok:#4ee29a;

      --focus: rgba(246,177,0,.26);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --toastBorder: rgba(78,226,154,.40);
      --toastBg: rgba(6,27,44,.86);
      --toastText: rgba(210,255,235,.95);
    }

    html[data-theme="light"]{
      --bg1:#f6f8ff;
      --bg2:#eef2ff;

      --card1: rgba(0,0,0,.03);
      --card2: rgba(0,0,0,.02);
      --border: rgba(0,0,0,.10);

      --text:#0b1220;
      --muted: rgba(11,18,32,.65);

      --shadow: 0 14px 40px rgba(10,25,45,.10);

      --input: rgba(0,0,0,.03);
      --inputBorder: rgba(0,0,0,.12);

      --focus: rgba(246,177,0,.22);

      --toastBorder: rgba(16,185,129,.35);
      --toastBg: rgba(255,255,255,.92);
      --toastText: rgba(11,18,32,.92);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      font-family: "Cairo", Arial, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif;
      font-weight: 400;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 20% 10%, rgba(246,177,0,.13), transparent 60%),
        radial-gradient(900px 420px at 80% 20%, rgba(78,226,154,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    /* readability: bold main / normal text normal */
    .titleBlock p,.notice,.ruleBox,.panelHeader p,.mini,.chip,.bigCaption,.footerText{
      font-weight: 500;
    }
    .titleBlock h1,.panelHeader h2,.tab,.btn,.label,.thead,.badge,.bigNumber,.footerTitle{
      font-weight: 900;
    }
    .trow{ font-weight: 500; }
    input,select,textarea{ font-weight: 500; }
    input::placeholder{ font-weight: 400; }

    .wrap{
      max-width: 1060px;
      margin: 34px auto 40px;
      padding: 0 16px;
    }

.topbar{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap: 14px;
  margin-bottom: 14px;
}

    .titleBlock h1{
      margin:0;
      font-size: 34px;
      letter-spacing: .2px;
      line-height: 1.15;
    }
    .titleBlock p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .topActions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(8px);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    html[data-theme="light"] .chip{
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(6px);
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      transition: .14s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    html[data-theme="light"] .btn{
      background: rgba(255,255,255,.70);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    html[data-theme="light"] .btn:hover{ border-color: rgba(0,0,0,.16); }
    .btn:active{ transform: translateY(0px); }

    .btn.gold{
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      border-color: rgba(0,0,0,.18);
      color: #1b1400;
      box-shadow: 0 10px 26px rgba(246,177,0,.25);
    }
    .btn.gold:hover{ filter: brightness(1.02); }

    .btn.danger{
      border-color: rgba(255,91,91,.45);
      background: rgba(255,91,91,.10);
      color: #ffd7d7;
    }
    html[data-theme="light"] .btn.danger{
      color: #6b0f0f;
      background: rgba(255,91,91,.14);
    }

    .notice{
      margin-top: 14px;
      border-radius: 999px;
      padding: 12px 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      backdrop-filter: blur(8px);
      text-align:center;
      font-size: 13px;
      line-height: 1.55;
    }
    html[data-theme="light"] .notice{
      background: rgba(255,255,255,.70);
    }

    .tabs{
      margin-top: 18px;
      display:flex;
      justify-content:center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tab{
      min-width: 190px;
      padding: 11px 16px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    html[data-theme="light"] .tab{
      background: rgba(255,255,255,.70);
    }
    .tab.active{
      background: rgba(246,177,0,.16);
      border-color: rgba(246,177,0,.40);
      box-shadow: 0 12px 30px rgba(246,177,0,.12);
    }

    .panel{
      margin-top: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--card1), var(--card2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    html[data-theme="light"] .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.75));
    }

    .panelHeader{
      padding: 18px 18px 0;
      text-align:center;
    }
    .panelHeader h2{
      margin: 0;
      font-size: 30px;
      letter-spacing: .2px;
    }
    .panelHeader p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      padding: 0 10px 10px;
    }

    .ruleBox{
      margin: 14px 18px 0;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding: 12px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      text-align: center;
    }
    html[data-theme="light"] .ruleBox{
      background: rgba(255,255,255,.70);
    }

    .content{
      padding: 18px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
      .panelHeader h2{ font-size: 26px; }
      .titleBlock h1{ font-size: 30px; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .label{
      font-size: 12px;
      color: rgba(234,242,255,.86);
    }
    html[data-theme="light"] .label{
      color: rgba(11,18,32,.78);
    }

    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--inputBorder);
      background: var(--input);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(234,242,255,.55); }
    html[data-theme="light"] input::placeholder{ color: rgba(11,18,32,.45); }

    input:focus, select:focus, textarea:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(246,177,0,.55);
    }

    .table{
      margin-top: 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow:hidden;
      background: rgba(0,0,0,.10);
    }
    html[data-theme="light"] .table{
      background: rgba(255,255,255,.55);
    }

    .thead, .trow{
      display:grid;
      grid-template-columns: 110px 120px 140px 140px 1fr 120px;
      gap: 10px;
      align-items:center;
      padding: 12px 12px;
    }
    .thead{
      background: rgba(255,255,255,.06);
      color: rgba(234,242,255,.82);
      font-size: 12px;
    }
    html[data-theme="light"] .thead{
      background: rgba(0,0,0,.03);
      color: rgba(11,18,32,.78);
    }

    .trow{
      border-top: 1px solid rgba(255,255,255,.08);
    }
    html[data-theme="light"] .trow{
      border-top: 1px solid rgba(0,0,0,.06);
    }

    @media (max-width: 980px){
      .thead, .trow{ grid-template-columns: 110px 120px 140px 1fr; }
      .hide-md{ display:none; }
    }
    @media (max-width: 620px){
      .thead, .trow{ grid-template-columns: 110px 1fr; }
      .hide-sm{ display:none; }
    }

    .cell{ min-width:0; }

    .codeInput{
      font-family: var(--mono);
      letter-spacing: .2px;
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(234,242,255,.92);
      font-size: 12px;
      gap: 6px;
      white-space: nowrap;
    }
    html[data-theme="light"] .badge{
      border-color: rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      color: rgba(11,18,32,.88);
    }

    .badge.ok{ border-color: rgba(78,226,154,.35); background: rgba(78,226,154,.12); }
    .badge.warn{ border-color: rgba(246,177,0,.35); background: rgba(246,177,0,.12); }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items:center;
      justify-content: space-between;
    }
    .actionsLeft, .actionsRight{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .bigResult{
      margin-top: 18px;
      text-align:center;
      padding: 18px 16px 10px;
    }
    .bigNumber{
      font-size: 56px;
      letter-spacing: .6px;
      margin: 4px 0 0;
    }
    .bigCaption{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .toast{
      position: fixed;
      top: 16px;
      left: 16px;
      right: 16px;
      margin: 0 auto;
      max-width: 620px;
      display:none;
      z-index: 999;
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid var(--toastBorder);
      background: var(--toastBg);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      color: var(--toastText);
      font-weight: 900;
      text-align: center;
    }

    .printOnly{ display:none; }

    /* Footer (Always English) */
    .siteFooter{
      margin-top: 30px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    html[data-theme="light"] .siteFooter{
      background: rgba(255,255,255,.65);
    }
    .footerInner{
      max-width: 1060px;
      margin: 0 auto;
      padding: 18px 16px 10px;
      text-align: center;
    }
    .footerTitle{
      font-size: 14px;
      margin: 0;
    }
    .footerText{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.6;
    }
    .footerBottom{
      border-top: 1px solid var(--border);
      padding: 10px 16px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
    }
    .footerLink{
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    @media print{
      body{ background:#fff; color:#111; }
      .wrap{ max-width: 100%; margin: 0; padding: 0; }
      .topbar, .tabs, .notice, .ruleBox, .actions, .btn, .chip, .siteFooter { display:none !important; }
      .panel{ box-shadow:none; border:1px solid #ddd; background:#fff; }
      .panelHeader{ padding: 12px 12px 0; }
      .content{ padding: 12px; }
      .table{ border:1px solid #ddd; background:#fff; }
      .thead{ background:#f3f4f6; color:#111; }
      input, select { border:1px solid #ddd; background:#fff; color:#111; }
      .printOnly{ display:block; margin: 0 0 10px; }
      .bigNumber{ color:#111; }
      .bigCaption, .mini{ color:#333; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="wrap">

  <div class="topbar">

    <!-- center brand -->
    <div class="titleBlock">
      <div class="brand">
        <img src="./aou-logo.png" alt="Arab Open University">
        <div class="brandText">
          <h1 data-i18n="appTitle">AOU GPA Calculator</h1>
          <p data-i18n="appSub">
            Calculate current GPA and forecast expected GPA on a 4.0 scale (AOU policy)
          </p>
        </div>
      </div>
    </div>

    <!-- actions -->
    <div class="topActions">
      <span class="chip" id="scaleChip">Scale: 4.0</span>
      <button class="btn" id="btnCopyLink">Copy link</button>
      <button class="btn" id="btnTheme">üåô</button>
      <button class="btn" id="btnAR">AR</button>
      <button class="btn" id="btnEN">EN</button>
    </div>

  </div>
      <div class="titleBlock">
  <div class="brand">
    <img src="./aou-logo.png" alt="Arab Open University" class="logo">
    <div class="brandText">
      <h1 data-i18n="appTitle">ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿπÿØŸÑ - ÿßŸÑÿ¨ÿßŸÖÿπÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©</h1>
      <p data-i18n="appSub">ÿ™ÿ∑ÿ®ŸäŸÇ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä Ÿàÿ™ŸàŸÇÿπ ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿπŸÑŸâ ŸÖŸÇŸäÿßÿ≥ 4.0 (ŸàŸÅŸÇ ÿ≥ŸÑŸÖ AOU)</p>
    </div>
  </div>
</div>
  

      <div class="topActions">
        <span class="chip" id="scaleChip" data-i18n="scaleChip">Scale: 4.0</span>

        <button class="btn" id="btnCopyLink" type="button" data-i18n="copyLink">ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑</button>

        <!-- Theme toggle -->
        <button class="btn" id="btnTheme" type="button" title="Theme">üåô</button>

        <button class="btn" id="btnAR" type="button">AR</button>
        <button class="btn" id="btnEN" type="button">EN</button>
      </div>
    </div>

    <div class="notice" data-i18n="notice">
      ÿ™ŸÜÿ®ŸäŸá: ÿ£ÿØÿßÿ© ÿ∑ŸÑÿßÿ®Ÿäÿ© ŸÑŸÑÿ•ÿ±ÿ¥ÿßÿØ ŸÅŸÇÿ∑ ŸàŸÑŸäÿ≥ÿ™ ŸÜÿ∏ÿßŸÖŸãÿß ÿ±ÿ≥ŸÖŸäŸãÿß ŸÑŸÑÿ¨ÿßŸÖÿπÿ©.
    </div>

    <div class="tabs">
      <button class="tab active" id="tabExpected" type="button">
        <span>üìä</span><span data-i18n="tabExpected">ÿ™ŸàŸÇÿπ ÿßŸÑŸÖÿπÿØŸÑ</span>
      </button>
      <button class="tab" id="tabCurrent" type="button">
        <span>üìò</span><span data-i18n="tabCurrent">ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä</span>
      </button>
    </div>

    <!-- Expected GPA Panel -->
    <section class="panel" id="panelExpected">
      <div class="panelHeader">
        <div class="printOnly">
          <h2 data-i18n="printHeader">ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿπÿØŸÑ</h2>
        </div>
        <h2 data-i18n="expectedTitle">Expected GPA Forecast</h2>
        <p data-i18n="expectedDesc">
          Forecast your final cumulative GPA using completed hours, current GPA, and expected semester performance.
        </p>
      </div>

      <div class="content">
        <div class="grid2">
          <div class="field">
            <div class="label" data-i18n="curCgpa">Current cumulative GPA (0‚Äì4)</div>
            <input id="exp_baseGpa" type="number" step="0.01" min="0" max="4" placeholder="e.g., 2.82">
          </div>
          <div class="field">
            <div class="label" data-i18n="completedHours">Total completed credit hours</div>
            <input id="exp_baseHours" type="number" step="1" min="0" placeholder="e.g., 103">
          </div>
        </div>

        <div class="ruleBox" data-i18n="rule">
          Retake Rule: If you enter the same Course Code multiple times, only the latest attempt is counted (previous attempts become Replaced).
        </div>

        <div class="table" id="exp_table">
          <div class="thead">
            <div class="cell" data-i18n="colAction">Action</div>
            <div class="cell hide-sm" data-i18n="colStatus">Status</div>
            <div class="cell hide-md" data-i18n="colPoints">GPA Points</div>
            <div class="cell hide-md" data-i18n="colHours">Credit Hours</div>
            <div class="cell" data-i18n="colScore">Grade (0‚Äì100)</div>
            <div class="cell" data-i18n="colCode">Course Code</div>
          </div>
          <div id="exp_rows"></div>
        </div>

        <div class="actions">
          <div class="actionsLeft">
            <button class="btn" id="exp_export" type="button" data-i18n="exportJson">ÿ™ÿµÿØŸäÿ± (JSON)</button>
            <button class="btn" id="exp_reset" type="button" data-i18n="reset">ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑</button>
            <button class="btn" id="exp_autocalc" type="button" data-i18n="autoCalcOn">ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä: ÿ™ÿ¥ÿ∫ŸäŸÑ</button>
          </div>
          <div class="actionsRight">
            <button class="btn gold" id="exp_calc" type="button" data-i18n="calculate">ÿßÿ≠ÿ≥ÿ®</button>
            <button class="btn gold" id="exp_add" type="button" data-i18n="addCourse">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÇÿ±ÿ±</button>
          </div>
        </div>

        <div class="bigResult">
          <div class="bigNumber" id="exp_result">0.00</div>
          <div class="bigCaption" id="exp_caption" data-i18n="expCaption">
            Expected cumulative GPA after adding this semester.
          </div>
        </div>

        <div class="actions" style="margin-top:8px">
          <div class="actionsLeft">
            <button class="btn" id="exp_import" type="button" data-i18n="importJson">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ (JSON)</button>
            <input id="exp_importFile" type="file" accept="application/json" style="display:none">
          </div>
          <div class="actionsRight">
            <button class="btn" id="btnPrint" type="button" data-i18n="print">ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ±</button>
          </div>
        </div>

        <p class="mini" style="margin-top:10px" data-i18n="tipDecimal">
          Tip: You can enter decimals (e.g., 88.5). Letter & points are calculated automatically using AOU scale.
        </p>
      </div>
    </section>

    <!-- Current GPA Panel -->
    <section class="panel" id="panelCurrent" style="display:none">
      <div class="panelHeader">
        <h2 data-i18n="currentTitle">Current GPA Calculator</h2>
        <p data-i18n="currentDesc">
          Enter Course Code, Grade (0‚Äì100), and Credit Hours. GPA updates automatically (you can turn it off).
        </p>
      </div>

      <div class="content">
        <div class="ruleBox" data-i18n="rule">
          Retake Rule: If you enter the same Course Code multiple times, only the latest attempt is counted (previous attempts become Replaced).
        </div>

        <div class="table" id="cur_table">
          <div class="thead">
            <div class="cell" data-i18n="colAction">Action</div>
            <div class="cell hide-sm" data-i18n="colStatus">Status</div>
            <div class="cell hide-md" data-i18n="colPoints">GPA Points</div>
            <div class="cell hide-md" data-i18n="colHours">Credit Hours</div>
            <div class="cell" data-i18n="colScore">Grade (0‚Äì100)</div>
            <div class="cell" data-i18n="colCode">Course Code</div>
          </div>
          <div id="cur_rows"></div>
        </div>

        <div class="actions">
          <div class="actionsLeft">
            <button class="btn" id="cur_export" type="button" data-i18n="exportJson">ÿ™ÿµÿØŸäÿ± (JSON)</button>
            <button class="btn" id="cur_reset" type="button" data-i18n="reset">ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑</button>
            <button class="btn" id="cur_autocalc" type="button" data-i18n="autoCalcOn">ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä: ÿ™ÿ¥ÿ∫ŸäŸÑ</button>
          </div>
          <div class="actionsRight">
            <button class="btn gold" id="cur_calc" type="button" data-i18n="calculate">ÿßÿ≠ÿ≥ÿ®</button>
            <button class="btn gold" id="cur_add" type="button" data-i18n="addCourse">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÇÿ±ÿ±</button>
          </div>
        </div>

        <div class="bigResult">
          <div class="bigNumber" id="cur_result">0.00</div>
          <div class="bigCaption" id="cur_caption" data-i18n="curCaption">
            Current GPA for the entered courses (retake rule applied).
          </div>
        </div>

        <div class="actions" style="margin-top:8px">
          <div class="actionsLeft">
            <button class="btn" id="cur_import" type="button" data-i18n="importJson">ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ (JSON)</button>
            <input id="cur_importFile" type="file" accept="application/json" style="display:none">
          </div>
          <div class="actionsRight">
            <span class="chip" id="cur_hint" data-i18n="curHint">Enter all completed courses to compute your current GPA.</span>
          </div>
        </div>

        <p class="mini" style="margin-top:10px" data-i18n="tipDecimal">
          Tip: You can enter decimals (e.g., 88.5). Letter & points are calculated automatically using AOU scale.
        </p>
      </div>
    </section>
  </div>

  <!-- Footer (ALWAYS ENGLISH) -->
  <footer class="siteFooter">
    <div class="footerInner">
      <p class="footerTitle">AOU GPA Calculator</p>
      <p class="footerText">
        Built by <strong>Homam Shaaban</strong>. This is a student-built guidance tool and <strong>not</strong> an official university system.
        <br>
        Reference: AOU grading scale (A‚ÄìF) mapped to a 4.0 scale as shown in the project rubric.
      </p>
      <p class="footerText">
        <a class="footerLink" href="#" id="footerTop">Back to top</a>
      </p>
    </div>
    <div class="footerBottom">
      ¬© <span id="footerYear"></span> AOU GPA Calculator ‚Äî All rights reserved.
    </div>
  </footer>

<script>
/* =========================
   AOU Scale
========================= */
function aouFromScore(score){
  if (!Number.isFinite(score)) return { letter: "‚Äî", points: null };
  if (score >= 90) return { letter: "A",  points: 4.0 };
  if (score >= 82) return { letter: "B+", points: 3.5 };
  if (score >= 74) return { letter: "B",  points: 3.0 };
  if (score >= 66) return { letter: "C+", points: 2.5 };
  if (score >= 58) return { letter: "C",  points: 2.0 };
  if (score >= 50) return { letter: "D",  points: 1.0 };
  return { letter: "F", points: 0.0 };
}
function clampScore(v){
  if (!Number.isFinite(v)) return null;
  if (v < 0) return 0;
  if (v > 100) return 100;
  return v;
}

/* =========================
   i18n
========================= */
const i18n = {
  ar: {
    appTitle: "ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿπÿØŸÑ - ÿßŸÑÿ¨ÿßŸÖÿπÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©",
    appSub: "ÿ™ÿ∑ÿ®ŸäŸÇ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä Ÿàÿ™ŸàŸÇÿπ ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿπŸÑŸâ ŸÖŸÇŸäÿßÿ≥ 4.0 (ŸàŸÅŸÇ ÿ≥ŸÑŸÖ AOU)",
    scaleChip: "Scale: 4.0",
    copyLink: "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",
    notice: "ÿ™ŸÜÿ®ŸäŸá: ÿ£ÿØÿßÿ© ÿ∑ŸÑÿßÿ®Ÿäÿ© ŸÑŸÑÿ•ÿ±ÿ¥ÿßÿØ ŸÅŸÇÿ∑ ŸàŸÑŸäÿ≥ÿ™ ŸÜÿ∏ÿßŸÖŸãÿß ÿ±ÿ≥ŸÖŸäŸãÿß ŸÑŸÑÿ¨ÿßŸÖÿπÿ©.",

    tabExpected: "ÿ™ŸàŸÇÿπ ÿßŸÑŸÖÿπÿØŸÑ",
    tabCurrent: "ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä",

    expectedTitle: "ÿ™ŸàŸÇÿπ ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑŸÖÿ™ŸàŸÇÿπ",
    expectedDesc: "ÿ™ŸàŸÇŸëÿπ ŸÖÿπÿØŸÑŸÉ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ©ÿå ŸàÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸäÿå ŸàÿØÿ±ÿ¨ÿßÿ™ Ÿáÿ∞ÿß ÿßŸÑŸÅÿµŸÑ ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©.",
    currentTitle: "ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä",
    currentDesc: "ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑŸÖŸÇÿ±ÿ±ÿå ŸàÿßŸÑÿØÿ±ÿ¨ÿ© (0‚Äì100)ÿå ŸàÿßŸÑÿ≥ÿßÿπÿßÿ™. Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿØŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß (ŸäŸÖŸÉŸÜŸÉ ÿ•ŸäŸÇÿßŸÅŸá).",

    rule: "ŸÇÿßÿπÿØÿ© ÿßŸÑÿ•ÿπÿßÿØÿ©: ÿ•ÿ∞ÿß ÿ£ÿØÿÆŸÑÿ™ ŸÜŸÅÿ≥ Course Code ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ŸÖÿ±ÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿ¢ÿÆÿ± ŸÖÿ≠ÿßŸàŸÑÿ© ŸÅŸÇÿ∑ (Ÿàÿ™ÿµÿ®ÿ≠ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© Replaced).",

    curCgpa: "ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸä ÿßŸÑÿ≠ÿßŸÑŸä (0‚Äì4)",
    completedHours: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ©",

    colAction: "ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°",
    colStatus: "ÿßŸÑÿ≠ÿßŸÑÿ©",
    colPoints: "ÿßŸÑŸÜŸÇÿßÿ∑",
    colHours: "ÿßŸÑÿ≥ÿßÿπÿßÿ™",
    colScore: "ÿßŸÑÿØÿ±ÿ¨ÿ© (0‚Äì100)",
    colCode: "ŸÉŸàÿØ ÿßŸÑŸÖŸÇÿ±ÿ±",

    addCourse: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÇÿ±ÿ±",
    calculate: "ÿßÿ≠ÿ≥ÿ®",
    reset: "ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑",
    exportJson: "ÿ™ÿµÿØŸäÿ± (JSON)",
    importJson: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ (JSON)",
    print: "ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÇÿ±Ÿäÿ±",
    autoCalcOn: "ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä: ÿ™ÿ¥ÿ∫ŸäŸÑ",
    autoCalcOff: "ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä: ÿ•ŸäŸÇÿßŸÅ",

    expCaption: "ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸä ÿßŸÑŸÖÿ™ŸàŸÇÿπ ÿ®ÿπÿØ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÅÿµŸÑ.",
    curCaption: "ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÑŸÖŸÇÿ±ÿ±ÿßÿ™ ÿßŸÑŸÖŸèÿØÿÆŸÑÿ© (ŸÖÿπ ÿ™ÿ∑ÿ®ŸäŸÇ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ•ÿπÿßÿØÿ©).",
    curHint: "ÿ£ÿØÿÆŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÇÿ±ÿ±ÿßÿ™ ÿßŸÑŸÖŸèŸÜÿ¨ÿ≤ÿ© ŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿπÿØŸÑŸÉ ÿßŸÑÿ≠ÿßŸÑŸä.",
    tipDecimal: "ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ™ŸÇÿØÿ± ÿ™ÿØÿÆŸÑ ŸÅŸàÿßÿµŸÑ (ŸÖÿ´ŸÑ 88.5). ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÑÿ≠ÿ±ŸÅ ŸàÿßŸÑŸÜŸÇÿßÿ∑ Ÿäÿ™ŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ÿ≠ÿ≥ÿ® ÿ≥ŸÑŸÖ AOU.",

    statusCounted: "ŸÖŸèÿ≠ÿ™ÿ≥ÿ®",
    statusReplaced: "ŸÖÿ≥ÿ™ÿ®ÿØŸÑ",
    del: "ÿ≠ÿ∞ŸÅ",

    placeholderCode: "ŸÖÿ´ÿßŸÑ: ITC101",
    placeholderScore: "ŸÖÿ´ÿßŸÑ: 88.5",
    placeholderHours: "ŸÖÿ´ÿßŸÑ: 3",

    toastLink: "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚úÖ",
    toastJson: "ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± JSON ‚úÖ",
    toastImported: "ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ‚úÖ",
    toastReset: "ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑ ‚úÖ",
    toastCopied: "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ‚úÖ",

    alertNeedBase: "ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿπÿØŸÑ ÿßŸÑÿ≠ÿßŸÑŸä ŸàÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ© ÿ£ŸàŸÑÿßŸã.",
    alertInvalidRow: "ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑŸÖŸÇÿ±ÿ± + ÿßŸÑÿ≥ÿßÿπÿßÿ™ + ÿßŸÑÿØÿ±ÿ¨ÿ© (0‚Äì100) ŸÑŸÉŸÑ ŸÖŸÇÿ±ÿ±.",
    printHeader: "ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑŸÖÿπÿØŸÑ"
  },
  en: {
    appTitle: "AOU GPA Calculator",
    appSub: "Calculate current GPA and forecast expected GPA on a 4.0 scale (AOU policy)",
    scaleChip: "Scale: 4.0",
    copyLink: "Copy link",
    notice: "Notice: This is a student guidance tool and not an official university system.",

    tabExpected: "Expected GPA",
    tabCurrent: "Current GPA",

    expectedTitle: "Expected GPA Forecast",
    expectedDesc: "Forecast your final cumulative GPA using completed hours, current GPA, and expected semester performance.",
    currentTitle: "Current GPA Calculator",
    currentDesc: "Enter Course Code, Grade (0‚Äì100), and Credit Hours. GPA updates automatically (you can turn it off).",

    rule: "Retake Rule: If you enter the same Course Code multiple times, only the latest attempt is counted (previous attempts become Replaced).",

    curCgpa: "Current cumulative GPA (0‚Äì4)",
    completedHours: "Total completed credit hours",

    colAction: "Action",
    colStatus: "Status",
    colPoints: "GPA Points",
    colHours: "Credit Hours",
    colScore: "Grade (0‚Äì100)",
    colCode: "Course Code",

    addCourse: "Add Course",
    calculate: "Calculate",
    reset: "Reset",
    exportJson: "Export (JSON)",
    importJson: "Import (JSON)",
    print: "Print Report",
    autoCalcOn: "Auto-calc: ON",
    autoCalcOff: "Auto-calc: OFF",

    expCaption: "Expected cumulative GPA after adding this semester.",
    curCaption: "Current GPA for the entered courses (retake rule applied).",
    curHint: "Enter all completed courses to compute your current GPA.",
    tipDecimal: "Tip: You can enter decimals (e.g., 88.5). Letter & points are calculated automatically using AOU scale.",

    statusCounted: "Counted",
    statusReplaced: "Replaced",
    del: "Delete",

    placeholderCode: "e.g., ITC101",
    placeholderScore: "e.g., 88.5",
    placeholderHours: "e.g., 3",

    toastLink: "Link copied ‚úÖ",
    toastJson: "JSON exported ‚úÖ",
    toastImported: "Imported ‚úÖ",
    toastReset: "Reset ‚úÖ",
    toastCopied: "Copied ‚úÖ",

    alertNeedBase: "Please enter your current GPA and completed hours first.",
    alertInvalidRow: "Please enter Course Code, Credit Hours, and Grade (0‚Äì100) for each course.",
    printHeader: "GPA Calculator Report"
  }
};

let LANG = localStorage.getItem("site_lang") || "ar";
function t(key){
  return (i18n[LANG] && i18n[LANG][key]) ? i18n[LANG][key] : key;
}
function $(id){ return document.getElementById(id); }

function setLang(lang){
  LANG = lang;
  localStorage.setItem("site_lang", lang);
  document.documentElement.lang = lang;
  document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });

  updateAllRowPlaceholders();
  refreshAutoCalcButtons();
  computeCurrent(false);
  computeExpected(false);
}

/* =========================
   THEME (Light/Dark)
========================= */
const THEME_KEY = "site_theme";

function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
  updateThemeButton();
}
function getPreferredTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === "light" || saved === "dark") return saved;
  return (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) ? "light" : "dark";
}
function updateThemeButton(){
  const theme = document.documentElement.getAttribute("data-theme") || "dark";
  const btn = $("btnTheme");
  btn.textContent = (theme === "dark") ? "üåô" : "‚òÄÔ∏è";
  btn.title = (theme === "dark") ? "Dark" : "Light";
}

/* =========================
   Storage
========================= */
const STORAGE_KEY = "aou_gpa_app_v1";

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{
    return null;
  }
}

function getNum(id){
  const v = Number($(id).value);
  return Number.isFinite(v) ? v : NaN;
}

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>{ el.style.display = "none"; }, 1500);
}

function downloadText(filename, text){
  const blob = new Blob([text], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function safeUpper(s){
  return String(s || "").trim().toUpperCase();
}

function clearRows(containerId){
  const c = $(containerId);
  while(c.firstChild) c.removeChild(c.firstChild);
}

let EXPECTED_AUTOCALC = true;
let CURRENT_AUTOCALC = true;

function currentRowsData(){
  return Array.from($("cur_rows").children).map(row=>({
    code: row.querySelector('[data-act="code"]').value,
    score: row.querySelector('[data-act="score"]').value === "" ? "" : Number(row.querySelector('[data-act="score"]').value),
    hours: row.querySelector('[data-act="hours"]').value === "" ? "" : Number(row.querySelector('[data-act="hours"]').value),
  }));
}
function expectedRowsData(){
  return Array.from($("exp_rows").children).map(row=>({
    code: row.querySelector('[data-act="code"]').value,
    score: row.querySelector('[data-act="score"]').value === "" ? "" : Number(row.querySelector('[data-act="score"]').value),
    hours: row.querySelector('[data-act="hours"]').value === "" ? "" : Number(row.querySelector('[data-act="hours"]').value),
  }));
}

function saveState(){
  const state = {
    lang: LANG,
    theme: document.documentElement.getAttribute("data-theme") || "dark",
    lastTab: localStorage.getItem("last_tab") || "expected",
    current: { rows: currentRowsData(), auto: CURRENT_AUTOCALC },
    expected: {
      baseGpa: getNum("exp_baseGpa"),
      baseHours: getNum("exp_baseHours"),
      rows: expectedRowsData(),
      auto: EXPECTED_AUTOCALC
    }
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function restoreState(){
  const st = loadState();
  if(!st) return;

  if(st.theme === "light" || st.theme === "dark") applyTheme(st.theme);
  if(st.lang) LANG = st.lang;

  if(st.expected){
    if(Number.isFinite(st.expected.baseGpa)) $("exp_baseGpa").value = st.expected.baseGpa;
    if(Number.isFinite(st.expected.baseHours)) $("exp_baseHours").value = st.expected.baseHours;
    EXPECTED_AUTOCALC = !!st.expected.auto;

    clearRows("exp_rows");
    (st.expected.rows || []).forEach(r => addRow("exp_rows", r));
    if((st.expected.rows || []).length === 0) addRow("exp_rows");
  }

  if(st.current){
    CURRENT_AUTOCALC = !!st.current.auto;
    clearRows("cur_rows");
    (st.current.rows || []).forEach(r => addRow("cur_rows", r));
    if((st.current.rows || []).length === 0) addRow("cur_rows");
  }

  setLang(LANG);
  refreshAutoCalcButtons();
}

/* =========================
   Row UI
========================= */
function rowTemplate(data = {}){
  const code = data.code ?? "";
  const score = (data.score ?? "") === "" ? "" : String(data.score);
  const hours = (data.hours ?? "") === "" ? "" : String(data.hours);

  const div = document.createElement("div");
  div.className = "trow";
  div.innerHTML = `
    <div class="cell">
      <button class="btn danger" type="button" data-act="del">${t("del")}</button>
    </div>

    <div class="cell hide-sm">
      <span class="badge warn" data-act="status">${t("statusCounted")}</span>
    </div>

    <div class="cell hide-md">
      <span class="badge" data-act="points">‚Äî</span>
      <div class="mini" style="margin-top:4px" data-act="letter">‚Äî</div>
    </div>

    <div class="cell hide-md">
      <input data-act="hours" inputmode="numeric" type="number" min="0" step="1"
        placeholder="${t("placeholderHours")}" value="${hours}">
    </div>

    <div class="cell">
      <input data-act="score" inputmode="decimal" type="number" min="0" max="100" step="0.01"
        placeholder="${t("placeholderScore")}" value="${score}">
    </div>

    <div class="cell">
      <input data-act="code" class="codeInput" type="text"
        placeholder="${t("placeholderCode")}" value="${code}">
    </div>
  `;
  return div;
}

function addRow(containerId, data){
  const row = rowTemplate(data);
  $(containerId).appendChild(row);
  hookRowEvents(row, containerId);
  updateRowComputed(row);
  saveState();
}

function hookRowEvents(row, containerId){
  row.querySelector('[data-act="del"]').addEventListener("click", ()=>{
    row.remove();
    if($(containerId).children.length === 0) addRow(containerId);
    recomputeByContainer(containerId);
    saveState();
  });

  ["code","score","hours"].forEach(act=>{
    const el = row.querySelector(`[data-act="${act}"]`);
    el.addEventListener("input", ()=>{
      if(act === "score"){
        const n = clampScore(Number(el.value));
        if(Number.isFinite(n)) el.value = String(n);
      }
      updateRowComputed(row);
      maybeAutoCalc(containerId);
      saveState();
    });
  });
}

function updateRowComputed(row){
  const scoreEl = row.querySelector('[data-act="score"]');
  const hoursEl = row.querySelector('[data-act="hours"]');

  const score = Number(scoreEl.value);
  const hours = Number(hoursEl.value);

  const gp = aouFromScore(score);
  const pointsBadge = row.querySelector('[data-act="points"]');
  const letterEl = row.querySelector('[data-act="letter"]');

  if(Number.isFinite(score) && scoreEl.value !== ""){
    letterEl.textContent = gp.letter;
  } else {
    letterEl.textContent = "‚Äî";
  }

  if(Number.isFinite(score) && Number.isFinite(hours) && hoursEl.value !== "" && gp.points !== null){
    pointsBadge.textContent = gp.points.toFixed(1);
  } else if (Number.isFinite(score) && gp.points !== null){
    pointsBadge.textContent = gp.points.toFixed(1);
  } else {
    pointsBadge.textContent = "‚Äî";
  }
}

function updateAllRowPlaceholders(){
  ["exp_rows","cur_rows"].forEach(containerId=>{
    Array.from($(containerId).children).forEach(row=>{
      row.querySelector('[data-act="del"]').textContent = t("del");
      row.querySelector('[data-act="hours"]').placeholder = t("placeholderHours");
      row.querySelector('[data-act="score"]').placeholder = t("placeholderScore");
      row.querySelector('[data-act="code"]').placeholder = t("placeholderCode");
    });
  });
}

/* =========================
   Retake Rule + Computation
========================= */
function extractRows(containerId){
  const rows = Array.from($(containerId).children);
  const parsed = rows.map((row, idx)=>{
    const code = safeUpper(row.querySelector('[data-act="code"]').value);
    const scoreStr = row.querySelector('[data-act="score"]').value;
    const hoursStr = row.querySelector('[data-act="hours"]').value;

    const score = (scoreStr === "") ? NaN : Number(scoreStr);
    const hours = (hoursStr === "") ? NaN : Number(hoursStr);

    return { idx, row, code, score, hours };
  });

  const lastIndex = new Map();
  parsed.forEach(p=>{ if(p.code) lastIndex.set(p.code, p.idx); });

  parsed.forEach(p=>{
    const statusEl = p.row.querySelector('[data-act="status"]');
    if(!p.code){
      statusEl.textContent = t("statusCounted");
      statusEl.classList.remove("ok");
      statusEl.classList.add("warn");
      return;
    }
    const isLast = lastIndex.get(p.code) === p.idx;
    statusEl.textContent = isLast ? t("statusCounted") : t("statusReplaced");
    statusEl.classList.toggle("ok", isLast);
    statusEl.classList.toggle("warn", !isLast);
  });

  return parsed.filter(p=>{
    if(!p.code) return true;
    return lastIndex.get(p.code) === p.idx;
  });
}

function validateRow(p){
  if(!p.code) return false;
  if(!Number.isFinite(p.hours) || p.hours <= 0) return false;
  if(!Number.isFinite(p.score)) return false;
  const s = clampScore(p.score);
  if(s === null) return false;
  return true;
}

function computeRowsGpa(containerId){
  const counted = extractRows(containerId);

  let totalPoints = 0;
  let totalHours = 0;

  for(const p of counted){
    if(!p.code) continue;
    if(!validateRow(p)) return { ok:false };

    const sc = clampScore(p.score);
    const gp = aouFromScore(sc);
    totalHours += p.hours;
    totalPoints += (gp.points * p.hours);
  }

  if(totalHours <= 0) return { ok:true, gpa: 0, totalHours, totalPoints };
  return { ok:true, gpa: (totalPoints / totalHours), totalHours, totalPoints };
}

function computeExpected(showAlerts = true){
  const baseGpa = Number($("exp_baseGpa").value);
  const baseHours = Number($("exp_baseHours").value);

  if(!(Number.isFinite(baseGpa) && Number.isFinite(baseHours) && baseHours >= 0 && baseGpa >= 0)){
    if(showAlerts) alert(t("alertNeedBase"));
    return { ok:false };
  }

  const term = computeRowsGpa("exp_rows");
  if(!term.ok){
    if(showAlerts) alert(t("alertInvalidRow"));
    return { ok:false };
  }

  const basePoints = baseGpa * baseHours;
  const finalHours = baseHours + term.totalHours;
  const finalPoints = basePoints + term.totalPoints;

  const finalGpa = (finalHours > 0) ? (finalPoints / finalHours) : 0;

  $("exp_result").textContent = finalGpa.toFixed(2);
  $("exp_caption").textContent = t("expCaption");
  return { ok:true, finalGpa };
}

function computeCurrent(showAlerts = true){
  const cur = computeRowsGpa("cur_rows");
  if(!cur.ok){
    if(showAlerts) alert(t("alertInvalidRow"));
    return { ok:false };
  }
  $("cur_result").textContent = cur.gpa.toFixed(2);
  $("cur_caption").textContent = t("curCaption");
  return { ok:true, gpa: cur.gpa };
}

function recomputeByContainer(containerId){
  if(containerId === "exp_rows") computeExpected(false);
  if(containerId === "cur_rows") computeCurrent(false);
}

function maybeAutoCalc(containerId){
  if(containerId === "exp_rows" && EXPECTED_AUTOCALC) computeExpected(false);
  if(containerId === "cur_rows" && CURRENT_AUTOCALC) computeCurrent(false);
}

function refreshAutoCalcButtons(){
  $("exp_autocalc").textContent = EXPECTED_AUTOCALC ? t("autoCalcOn") : t("autoCalcOff");
  $("cur_autocalc").textContent = CURRENT_AUTOCALC ? t("autoCalcOn") : t("autoCalcOff");
}

/* =========================
   Export / Import
========================= */
function exportJson(kind){
  const payload = {
    version: 1,
    kind,
    lang: LANG,
    timestamp: new Date().toISOString(),
    data: null
  };

  if(kind === "current"){
    payload.data = { rows: currentRowsData(), auto: CURRENT_AUTOCALC };
  } else {
    payload.data = {
      baseGpa: $("exp_baseGpa").value,
      baseHours: $("exp_baseHours").value,
      rows: expectedRowsData(),
      auto: EXPECTED_AUTOCALC
    };
  }

  downloadText(`aou-gpa-${kind}.json`, JSON.stringify(payload, null, 2));
  toast(t("toastJson"));
}

function importJsonFromFile(file, kind){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result || ""));
      if(!obj || !obj.data) throw new Error("bad");

      if(kind === "current"){
        const rows = (obj.data.rows || []);
        CURRENT_AUTOCALC = !!obj.data.auto;
        clearRows("cur_rows");
        rows.forEach(r => addRow("cur_rows", r));
        if(rows.length === 0) addRow("cur_rows");
      } else {
        const rows = (obj.data.rows || []);
        $("exp_baseGpa").value = obj.data.baseGpa ?? "";
        $("exp_baseHours").value = obj.data.baseHours ?? "";
        EXPECTED_AUTOCALC = !!obj.data.auto;
        clearRows("exp_rows");
        rows.forEach(r => addRow("exp_rows", r));
        if(rows.length === 0) addRow("exp_rows");
      }

      refreshAutoCalcButtons();
      setLang(LANG);
      toast(t("toastImported"));
      saveState();
    }catch{
      alert("Invalid JSON file");
    }
  };
  reader.readAsText(file);
}

/* =========================
   Tabs
========================= */
function showPanel(which){
  const isExp = (which === "expected");
  $("panelExpected").style.display = isExp ? "block" : "none";
  $("panelCurrent").style.display = isExp ? "none" : "block";

  $("tabExpected").classList.toggle("active", isExp);
  $("tabCurrent").classList.toggle("active", !isExp);

  localStorage.setItem("last_tab", which);
  saveState();
}

/* =========================
   Copy link
========================= */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast(t("toastCopied"));
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    toast(t("toastCopied"));
  }
}

/* =========================
   Init
========================= */
function init(){
  // footer year + top
  $("footerYear").textContent = new Date().getFullYear();
  $("footerTop").addEventListener("click", (e)=>{ e.preventDefault(); window.scrollTo({top:0, behavior:"smooth"}); });

  // theme init
  applyTheme(getPreferredTheme());

  // Tabs
  $("tabExpected").addEventListener("click", ()=> showPanel("expected"));
  $("tabCurrent").addEventListener("click", ()=> showPanel("current"));
  showPanel(localStorage.getItem("last_tab") || "expected");

  // Language
  $("btnAR").addEventListener("click", ()=> setLang("ar"));
  $("btnEN").addEventListener("click", ()=> setLang("en"));

  // Theme toggle
  $("btnTheme").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
    saveState();
  });

  // Copy link
  $("btnCopyLink").addEventListener("click", ()=>{
    copyText(location.href);
    toast(t("toastLink"));
  });

  // Expected
  $("exp_add").addEventListener("click", ()=> addRow("exp_rows"));
  $("exp_calc").addEventListener("click", ()=> computeExpected(true));
  $("exp_reset").addEventListener("click", ()=>{
    $("exp_baseGpa").value = "";
    $("exp_baseHours").value = "";
    clearRows("exp_rows");
    addRow("exp_rows");
    $("exp_result").textContent = "0.00";
    toast(t("toastReset"));
    saveState();
  });
  $("exp_autocalc").addEventListener("click", ()=>{
    EXPECTED_AUTOCALC = !EXPECTED_AUTOCALC;
    refreshAutoCalcButtons();
    if(EXPECTED_AUTOCALC) computeExpected(false);
    saveState();
  });
  $("exp_export").addEventListener("click", ()=> exportJson("expected"));
  $("exp_import").addEventListener("click", ()=> $("exp_importFile").click());
  $("exp_importFile").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(file) importJsonFromFile(file, "expected");
    e.target.value = "";
  });
  $("exp_baseGpa").addEventListener("input", ()=>{ if(EXPECTED_AUTOCALC) computeExpected(false); saveState(); });
  $("exp_baseHours").addEventListener("input", ()=>{ if(EXPECTED_AUTOCALC) computeExpected(false); saveState(); });

  // Current
  $("cur_add").addEventListener("click", ()=> addRow("cur_rows"));
  $("cur_calc").addEventListener("click", ()=> computeCurrent(true));
  $("cur_reset").addEventListener("click", ()=>{
    clearRows("cur_rows");
    addRow("cur_rows");
    $("cur_result").textContent = "0.00";
    toast(t("toastReset"));
    saveState();
  });
  $("cur_autocalc").addEventListener("click", ()=>{
    CURRENT_AUTOCALC = !CURRENT_AUTOCALC;
    refreshAutoCalcButtons();
    if(CURRENT_AUTOCALC) computeCurrent(false);
    saveState();
  });
  $("cur_export").addEventListener("click", ()=> exportJson("current"));
  $("cur_import").addEventListener("click", ()=> $("cur_importFile").click());
  $("cur_importFile").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(file) importJsonFromFile(file, "current");
    e.target.value = "";
  });

  // Print
  $("btnPrint").addEventListener("click", ()=> window.print());

  // Ensure at least one row
  if($("exp_rows").children.length === 0) addRow("exp_rows");
  if($("cur_rows").children.length === 0) addRow("cur_rows");

  // Restore saved data
  restoreState();

  // Ensure labels
  refreshAutoCalcButtons();
  setLang(LANG);

  // initial compute
  computeCurrent(false);
  computeExpected(false);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>



